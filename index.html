<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BigBook.study — Highlighting & Annotation Guide (SPA)</title>
  <meta name="description" content="A simple, color‑coded system for studying the AA Big Book. Includes color legend, underline meanings, margin symbols, workflow, checklist, and print/export options — fully client‑side." />
  <meta name="robots" content="index,follow" />
  <!-- SEO meta tags -->
  <meta name="keywords" content="AA Big Book study, color coding, 12 Steps, inventory, amends, prayer, meditation, service, sponsor tools, BigBook study guide" />
  <meta name="author" content="Info@Manpasand.com" />
  <meta property="og:title" content="BigBook.study — Highlighting &amp; Annotation Guide" />
  <meta property="og:description" content="Color‑coded, client‑side tool for studying the AA Big Book with step worksheets, session helpers, trackers, and analytics." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="data:image/png;base64,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" />
  <meta property="og:url" content="https://bigbook.study" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="BigBook.study — Highlighting &amp; Annotation Guide" />
  <meta name="twitter:description" content="Comprehensive Big Book study tool with color coding, steps, inventory, amends, quizzes, and more." />
  <!-- Favicon -->
  <script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756237251243&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-EEhyNGyGhjGNCK4mgnpd8b%26ts%3D487844%26p%3Dfs%26cid%3D1%26sig%3D94fa5ad1c6ed07f16f846b0e1d2309ca967180bdc1d37ddcc149f27177ccfd90&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756237251243&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756190423093&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-KtHhDrsfjBBpgPNmyXAsEu%26ts%3D487830%26p%3Dfs%26cid%3D1%26sig%3Dc1b5fa9f85dbf4a763af77bf381eeeab6c29151db7136111558f1a2aa4acb5fe&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756190423093&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756188622492&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-EtiQoYWg18kNy8WWT9TciU%26ts%3D487830%26p%3Dfs%26cid%3D1%26sig%3D11c05b648268fb35940f6f49dde13a8d90415dcf261e47bc6d2d3984be710784&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756188622492&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><link rel="icon" type="image/png" href="data:image/png;base64,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" />
  <script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756186823797&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-BNCHoLRAiSH55hffj4rdNo%26ts%3D487830%26p%3Dfs%26cid%3D1%26sig%3Da28801b998d1e416b79b56a0a5cd01d41d1570e78d2d55b362d5120b66597328&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756186823797&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756186823797&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-TzhBmKx8KuMjXiXb8V4cY8%26ts%3D487829%26p%3Dfs%26cid%3D1%26sig%3D635af57223e3f98572dda5c65e141ae4f365745cc6db211a883e7620914258c6&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756186823797&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756185026722&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-F179oj83MzBEHWEpPDQjLb%26ts%3D487829%26p%3Dfs%26cid%3D1%26sig%3D9a7237eb6aa7c7f776c82bc0f6cf86f6d91cdb92e27c8394006c2900687b8b21&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756185026722&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756184208720&amp;type=content-script&amp;dmn=chatgpt.com&amp;url=https%3A%2F%2Fchatgpt.com%2Fbackend-api%2Festuary%2Fcontent%3Fid%3Dfile-2uSQn3KkLpoevBTrneRUET%26ts%3D487829%26p%3Dfs%26cid%3D1%26sig%3Da4057ff51caa63640363331b1cdb3f10fdef51f864a1a2c5fd57f1640cb8a6c3&amp;app=chrome.exe&amp;css=2&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="6a1ecf93e9ea40d69745a521409" src="//local.adguard.org?ts=1756184208720&amp;name=AdGuard%20Extra&amp;name=AdGuard%20Popup%20Blocker&amp;type=user-script"></script><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- External libs for PDF generation and fuzzy search -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <style>
    :root{
      --bg-grad-from: 222 100% 98%;
      --bg-grad-to: 210 100% 96%;
    }
    body{ font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .app-bg{ background: linear-gradient(135deg, hsl(var(--bg-grad-from)), hsl(var(--bg-grad-to))); }
    /* Underline styles */
    .u-single{ text-decoration-line: underline; text-decoration-thickness: 2px; }
    .u-wavy{ text-decoration-line: underline; text-decoration-style: wavy; text-decoration-thickness: 2px; }
    .u-dashed{ text-decoration-line: underline; text-decoration-style: dashed; text-decoration-thickness: 2px; }
    .u-dotted{ text-decoration-line: underline; text-decoration-style: dotted; text-decoration-thickness: 2px; }
    .u-double{ position: relative; }
    .u-double:after{
      content:''; position:absolute; left:0; right:0; bottom:-2px; height:1px; background: currentColor;
      box-shadow: 0 3px 0 0 currentColor; /* creates two lines */
    }
    @media print{
      .no-print{ display:none !important; }
      .card{ box-shadow: none !important; border-color:#e5e7eb !important; }
      body{ background: #fff !important; }
      .app-bg{ background:#fff !important; }
      a[href]:after{ content:""; }
    }
    /* Simple tooltip */
    .tip:hover .tip-content{ opacity:1; transform: translateY(-4px); pointer-events:auto; }

    /* Dimmed class for guided filters */
    .dimmed { opacity: 0.25 !important; }

    /* Private mode blur for sensitive sections */
    #step4.private-blur, #amends.private-blur { filter: blur(4px); pointer-events: none; }

    /* Accessibility enhancements */
    :focus-visible {
      outline: 2px dashed hsl(214, 32%, 40%);
      outline-offset: 2px;
    }
    /* High contrast mode overrides */
    .high-contrast {
      --bg-grad-from: 0 0% 15%;
      --bg-grad-to: 0 0% 10%;
      color: #f8f8f8;
    }
    .high-contrast .card{
      background-color: #1f2937 !important;
      border-color: #374151 !important;
      color: #f3f4f6 !important;
    }
    .high-contrast a{ color:#93c5fd !important; }

    /* Modern UI overrides */
    /* Force all cards to use a solid white background and remove the blur effect. */
    .card{
      background-color: #ffffff !important;
      backdrop-filter: none !important;
    }

  /* Modern input styles for a cleaner, more consistent look across the app. */
  input[type="text"],
  input[type="number"],
  input[type="date"],
  input[type="email"],
  input[type="password"],
  select,
  textarea {
    background-color: #F9FAFB;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    width: 100%;
    color: inherit;
  }

  /* Ensure buttons within forms stand out with consistent styling. */
  button {
    cursor: pointer;
  }
  </style>
</head>
<body class="app-bg min-h-screen text-slate-800">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 bg-white shadow-md border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap md:flex-nowrap items-center gap-4">
      <div class="flex items-center gap-3">
        <!-- Logo image -->
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAIAAABMXPacAAAOcUlEQVR4nO1dXYwdZRl+3u+bmXN2t9tuhVLbLaWUVAMREDUEQYFEjSSIJsgNNyZeEI0/eME1F94ZiTFceAEaEyJGDSZKlFRJoAhaflqqFAQUKNtuf7Z2/7p/3T0z871ezN/3zczZ0t3z7eyUebLdMzN7zpmZ53nf5/2+d+ac0tTUNBpUBwFQ1cewGtT64AFAVH0AqwR32V4bYeouQDdwTTQg0T2I6o5anBdfrBlQGzQCVIxGgAiVFYxGgAiVFYxGgGpBjQA61t6ImlGQgV4Z0QUIuS4EqMWI/UJwASe0LgSwk/m1mAmvDwHKsHr66pFX61aAetC3eqxbAT4saASoGI0AFaMRoFqsaiZcj3HehWNNz2s1AlysA5W1PK+mFVE1GgEqRiNAxWgEqBjioh3L1AMkajiWuZhChtcsA3q4G+71G1aJ82RA79Kj54lWv8wtxXmK8EUSZusYzSioYjQCVIyLV4Deuqc1L667AFRYSMA95cxWya/9jVlcWCj+aV2j7gLUHU07umo49t5aEtxYX2YmAApQDMXr0R0IIAEikIAgAmU1JAgQhrb2a0sAh3CqI56dcGYD4RJvdnnIVVs83uyqTQ5vkHAEAChGyFAVCSIEhIQQAMP3sTCPuVnMnOWZaZ6ZwfwsdxZpYAA3fk5echn7vpWjJBufE5YCp5bED94aOLooBAEMAojhEtqShxze6qpd/eGegfCq/nC4Tw05LAihotB+chBBSgiJMMDsDMZO4MRxHh3hsVM8PYmFOSwtcRgyKwLAgAp523bxwIPO5kvZRh5YyQCX8OyEc3RRDEgwA5T9XghozqejC+KlaQeMtsAWT+3pD28YCm7YFOzqV/2SQ6ZArUAJWmbkk/J+bh7HjuA/b/J/3+YTozxzloMAiLKBIgtiRwCIYoEAOnmSX/mHuvMeEYa9Dw9bFjTpCxnxHp1I8psACYjIXwmKcXJRjC6IZ864/ZJ394c3fSS4/dJgz4bQE/BVD9xJCDgu/A6OvEP/PKDeeE2dHmO/AyFYSJAg12Mg1o6RE5Gjdzg7Y2sqZkWA+EO6UdQjYx+IJYG2UQKSAEKg6M0Z5/C08/gIf2JjcOc2/7Yt/maPfUUfLPLyTxISjoOZKTp0gF96QY0cUR0fUkJKdr34BRzlJkwNtDcjAjOIaPkMWzGsCEAAc/YD5NnXZYhXATAcwBEImA5Muq9MuFf0h1/b3rlrh39ZW3VC+uDZIARcFxNn8MI+tf95deY0CwnpIOU9ekg/zc2xSybQF+MjZDspQJYsiBFRnPwYGYD8RkMVBgEuAcDovPzp231PHPPuvaJz987OBgdL5WXQiE3Pw9wc/vInte9pnphQjgO3lR5WPog5GSNniVCQOZcTPQXbmwcwo6QG5HmPwrCQK9GfJCAFTi/IH7/R99Qx9/tXL92y1Q9UMRXidSEgJV49gD/8Lhw9plwHnpccSvo8/UsMzO1sykDasRiPvYSdDIjjmJOGmMZpjvo09nOmBM4SQgJtgbfOOve/5Nyza+m71ywNOuyr/E5dl+Zm8fvfhC88pwButeJ3LrBtOky3LRrvbHFwbC8DIgaVtoyyPCiWBPOvqQwugRUef6f1+rj84WfOfXyTWtTsyGvh/Xf5l4+EI++rViuunPEQIHljPahzh2qslZLNsFSErfSCKDp3PZaRz2d9gfRqoZEeS5jWBkafwOEJ51vPDewfk+0keLwWHTqIh34UjBxTXhtMcbdDaZUIyQgnO4p0d+kekkPN5UM8ULKTBlYEYABMGYlIHDY6UWVQnJ22ST2rmH02n98SGF8UD/x94MVTsiXheTj4Mv/s4WBunl03Y1OlXJssJ4eXrSJlP0s/ZgYzZ6+15kGWMoB0h9FiLLOXmGIz6jM9lJkNSpNBwQVmO/Tg/r6xRRo9yo/+POwELGUWxV32rO1a38gmv0xR7dI1i0/LAix2Q4tzLmjBXjQo1s4400/frrJVl3B8Vj56qDXw8vzZWW57pJhRHKwbzOZd3CjR8S4p/7L0CO1MhS0W4SzY9dUi+2w+J/qTMqk3i0FkYp7En193rvo3XDflKJtPpVxTOa+a0uZxc2FrkjpWbMhiBgCGC+lTMJ3x3HI+6vWaoYwt0RWGNKMAEMf06ewrFGjm0uVyfk0L6r0GdjMgz7u2PV3O9yfYoLtIPRisQMkMDgnhxBnpRVb1uM5yQtuaZkmXzKidBaXFTTsfY9WMdC5bLVJv/EacCqVhGfHL2nJ2YEC+ucNUYjGRxlT+/r2CtV5Q8mgUgGXiPWc7ZVFvrLKxMbGgeN+kNdpgUkv5OkDpMcX/iLJ31MOoVjWA4lFmNMotJR3LZUDKfjobyId/+pKYxdj/08DPjIiL3pIeDZAxnRx7CdHMxLEwvYbNGqBbDQzWdD04aldorhI9jZSZE0ULiuZoud0mdOe7QAyUzme5e3uCtRVrNmRzFKTiODTG/l0Mp+g/XEq6WQNI05K0wE+9KCVOKwk5v88VhyLszYIBmxnA+a6O4aflRpRR34133Y4QZw8n11MoCXy9JOimo8lA56c+FbBshtcr2BOAMqKjDQxw3PpH2Y/ReluGfZV7YUkLTTf5pADEdCYGZXTK01fpAyPzdNhSJli8IJML85zVlI76L4D9ZDViklN2tKhPi0G0Hoe/cQEY5lIhE1jfWqcizHGPOeUUJaTrTbeu7HcTJsmnqGmpV9ek/MabKbMRwPQl85C7nwwAUN0mYpwVYejNBpUYRt5JcnENygV7qQYKcU1lFDTQ6rE2Ei3EOEMbYGazroKhWYL1bmg+6tGdd22BUiUUqNSUstxKi0y+uxlroBlOerOMyW/m7l2prlsNoNhwi55T+OFipJf6fnFGZsgQQ4/3aGZGmgIca7CM65cg3kOdJmJpV7iM9/xI1FymZAZAXGA5Jw+ya84xSvw93/TJJQRHM1xoM7hi261+FlTGfnm7TW85aBeHU9uhQjaQ/mRlahB3I0g/DL0PkT3qd50U7pwoaGBRAUsZwFHopY6fZ19p56rSVyTbVTKKKnqRNk0zEqtg+qnpaO5vpkZhOWfymQxM9hSw2IzTqckbSLESsOH4xhBI354sRMWZclMwRiRldk9Gtt1Ed0YpO/BYA873UHsJm72gnMmU1YMSZ9f0oG51WCUzapXELZfEeJ7lLn233JOz+xSzzcyZKD2GtRoQtSJM9jPicqlQGN0bFVgfibKhQbLFoCYfrQwknaLcxvKrXKz9TnwsvtfJgga2RkH4YE3QElNSWnVVhuF0bUhESEM4MY4siE2jomwtKxDLnYnx6h7D7kX58kZQMfY1cqNBDpXmRxr7WQMjafnBpCgKcPO6WAQzP/JTssKNu0ngL29fq4BjJ7M4PvvlfT/hl81lY+hZiH1SpirIfCIpA2X3mbPxYOqic22sc9LBVvp0uZcgx1Zy6VUXsY2kelCOepNTQ4OyLMnSRRvOZjPe7HJMssE4rvix4DscTyCJSNMvEY4tEWXLgq4cVKFKEre0KV3e3M/zTibpejUmBhRTcYTCgBbMXJYPpa6f1Ao2nkAIQwxvt3RzhJ3b0zshfelyf+9IsH/MAWLWiEGA4Gj8nnTnNbopDX/WKNZ+inU4eUJMMGX2EzGfNBlMFNmPw4PjO1BV8uHAqAV3/Q3y5ttkx7dBlZ3PCQOQAgs+PX/SGZkR00s0fY7GF8TkIs0s0tyiWPARBoCCjD40mfDLpumTVgY4WSXNqVpLwfCxKZFQnAxvtKoWZYNJeboWKoQhlAIB0kG7jzZswIaNtHGINm7C4CD19WF4h/jUjaLdZ+vD8rYsKFToc/gru3xBYDAz+QpLIeZ9Mb2IsTkxMi3fPiPemxDHp+X0AoUhJOBQLIbhRZyJQWyGv8r2mNyQnfzWVeBUA2ZFfsBKwXFpaLPYNkw7d9GuK2nrNtp8KW0YpHYbrgshs95c4Nv7qgKylQEluwJAEAARJMUN63MBjc/TO+Py0Ann1WPy3TNy5hwJhisglJYHbCREqoHXCXaMTlLOtUvB8ANmxsZN4ord4rpPio9dI4Yvp42byHWYAVaJ89jq/Jdj7QQo3330QWoBQbwY0OiUeHnEeeYt5/BxZ/YceQISmvPkhqQMrxMMj06KLoRFORCGHAQ0OEhXXytuukVefZ3YchkcFyqM/WfNwGVRUrEAOqLMcCT7Id47Lfe+7u59zRudEE70rSuhNihKWhqerwtguj8h9BEqXL5T3vpF57OfF9t2kBBs9atPVoB1JIAOR8IVPD5Le//l/vbF1pFT0pVwYHYpGK4fDJ+YyDIgibEwRBhg9x7nzrvljTeLwY3k+1a+amP1WKcCRBACLYen5sSTr7i/2tc6NSXaMhvUMsPz/e0nJomzWRWDO0v00e3i7nvdW78g2/3odJh76jOlTrJirGsBIghCy8WJCfGLv3p/3O+pkFwRj39c399+cpJUdC2GAx/SFXd81f36vc7QJVhaWgH1tno+Xfc3NTW95jtdCaSEK/C3w/InT/SNnJItFwAcPxg+OU7MIFpa5J27nfu+513/aeH7bOOrZWygBhmgo+3hf1P00K/bTx/0XBetwN82NsEhBwHd/mXvm992Nw3x0lI9qI9QMwEAOBJgfuyp1iNPtqkTbh0b7++jb9zXuuMuEap1Wmm7Yw0nYj0EEdoe7zvoPfyYs6Mz8537vWuuxeKipY6xXaxQgN6OBFYGz8XZGXIc9Pezb6dTtgZYYS+ocvYBdHwMDDAz6ss+rH9O2DLWspFgCc0351aMRoCK0QhQMcT6KKgfXogadCEuZtT+P3CoO5r/P6BqNAJUjEaAitEIUDEaASpGI0DFaASoGI0AFaNEgGZmvJYoEaDpDa0l1uy/NG9QjvP8l+YNbKMpwhWjEaBiNAJUjEaAitEIUDEaASpGI0CloEaAasGNAFWjEaBiNAJUjEaAitEIUDEaASpGI0DF+D/HkxFnQq+K3gAAAABJRU5ErkJggg==" alt="BigBook.study logo" class="size-8 rounded-xl shadow-inner" />
        <div>
          <h1 class="text-lg md:text-xl font-extrabold tracking-tight">BigBook.study</h1>
          <p class="text-xs md:text-sm text-slate-500 -mt-0.5">Highlighting & Annotation Guide</p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2 no-print">
        <button id="btnPrint" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Print / PDF</button>
        <button id="btnExport" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Export JSON</button>
        <button id="btnExportAll" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Export All</button>
        <button id="btnCopyShare" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Copy Link</button>
        <button id="btnShowQR" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">QR</button>
        <!-- Sanitize toggle for share links and Sponsor packet button -->
        <span class="flex items-center gap-1 text-xs md:text-sm">
          <input id="toggleSanitizeShare" type="checkbox" class="size-4" />
          <label for="toggleSanitizeShare" class="text-xs md:text-sm">Sanitize</label>
        </span>
        <button id="btnSponsorPacket" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Sponsor Packet</button>
        <label for="fileImport" class="px-3 py-2 rounded-full bg-white border border-indigo-600 text-indigo-600 text-xs md:text-sm hover:bg-indigo-50 cursor-pointer transition-colors shadow">Import JSON</label>
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
        <!-- Encrypted backup & restore buttons -->
        <button id="btnEncBackup" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Backup (Encrypted)</button>
        <button id="btnEncRestore" class="px-3 py-2 rounded-full bg-white border border-indigo-600 text-indigo-600 text-xs md:text-sm hover:bg-indigo-50 transition-colors shadow">Restore</button>
        <!-- Meeting mode button -->
        <button id="btnMeeting" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow">Meeting</button>
        <button id="btnReset" class="px-3 py-2 rounded-full bg-white border border-indigo-600 text-indigo-600 text-xs md:text-sm hover:bg-indigo-50 transition-colors shadow">Reset</button>
        <button id="btnInstall" class="px-3 py-2 rounded-full bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 transition-colors shadow hidden">Install</button>
        <span id="offlineStatus" class="px-2 py-1 rounded text-xs font-semibold hidden"></span>
        <!-- Settings button to open the preferences modal -->
        <button id="btnSettings" class="px-3 py-2 rounded-full bg-white border border-indigo-600 text-indigo-600 text-xs md:text-sm hover:bg-indigo-50 transition-colors shadow">
          <!-- Use a simple gear icon glyph for the settings button -->
          ⚙
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 md:py-10 grid md:grid-cols-[260px,1fr] gap-6">
    <!-- Sidebar -->
    <aside class="md:sticky md:top-20 h-max no-print">
      <!-- Primary navigation with top-level sections -->
      <nav class="bg-white border border-slate-200 rounded-2xl p-4 shadow-md space-y-2">
        <ul class="space-y-1">
          <!-- Removed explicit Home link. Users land on the Tools section by default, so a dedicated Home link is unnecessary. -->
          <li>
            <!-- Tools with nested submenu containing previous navigation groups -->
            <details open>
              <summary class="cursor-pointer select-none px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700 font-semibold flex items-center justify-between">
                <span class="flex-1"><a href="#tools" class="nav-main-link block w-full">Tools</a></span>
                <span class="ml-1">▸</span>
              </summary>
              <ul class="mt-1 space-y-2 pl-2">
                <!-- Overview group -->
                <details open>
                  <summary class="flex items-center justify-between cursor-pointer select-none font-semibold text-slate-700 uppercase text-xs tracking-wide py-2 px-2 rounded-md hover:bg-indigo-50">Overview</summary>
                  <ul class="mt-1 space-y-1">
                    <li><a href="#overview" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">How to use this guide</a></li>
                    <li><a href="#colors" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Color legend</a></li>
                    <li><a href="#underline" class="block px-3 py-2 rounded-lg hover-bg-indigo-50 text-sm text-slate-700">Underline key</a></li>
                    <li><a href="#symbols" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Margin symbols</a></li>
                    <li><a href="#lookfor" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">What to look for</a></li>
                    <li><a href="#steps" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step mapping</a></li>
                    <li><a href="#workflow" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Workflow</a></li>
                    <li><a href="#checklist" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Checklist</a></li>
                    <li><a href="#custom" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Custom codes</a></li>
                    <li><a href="#sampler" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Highlight sampler</a></li>
                    <!-- Link to the analog study framework section -->
                    <li><a href="#analog" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Analog framework</a></li>
                  </ul>
                </details>
                <!-- Step tools group -->
                <details>
                  <summary class="flex items-center justify-between cursor-pointer select-none font-semibold text-slate-700 uppercase text-xs tracking-wide py-2 px-2 rounded-md hover:bg-indigo-50">Step tools</summary>
                  <ul class="mt-1 space-y-1">
                    <li><a href="#step4" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 4 worksheet</a></li>
                    <li><a href="#step5" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 5 session</a></li>
                    <li><a href="#defects" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 6/7 mapper</a></li>
                    <li><a href="#amends" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 8/9 amends</a></li>
                    <li><a href="#step10" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 10 inventory</a></li>
                    <li><a href="#step11" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 11 planner</a></li>
                    <li><a href="#service" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Step 12 service</a></li>
                  </ul>
                </details>
                <!-- Practice & Review group -->
                <details>
                  <summary class="flex items-center justify-between cursor-pointer select-none font-semibold text-slate-700 uppercase text-xs tracking-wide py-2 px-2 rounded-md hover:bg-indigo-50">Practice &amp; Review</summary>
                  <ul class="mt-1 space-y-1">
                    <li><a href="#flashcards" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Flashcards</a></li>
                    <li><a href="#checkins" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Daily check‑ins</a></li>
                    <li><a href="#analytics" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Analytics</a></li>
                    <li><a href="#promises" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Promise tracker</a></li>
                    <li><a href="#readingPlan" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Reading plan</a></li>
                    <li><a href="#quiz" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Recall quiz</a></li>
                    <li><a href="#paletteTuner" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Palette tuner</a></li>
                    <li><a href="#compare" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Compare excerpts</a></li>
                  </ul>
                </details>
                <!-- Advanced tools group -->
                <details>
                  <summary class="flex items-center justify-between cursor-pointer select-none font-semibold text-slate-700 uppercase text-xs tracking-wide py-2 px-2 rounded-md hover:bg-indigo-50">Advanced tools</summary>
                  <ul class="mt-1 space-y-1">
                    <li><a href="#searchAll" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Find everything</a></li>
                    <li><a href="#drill" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Tagging drill</a></li>
                    <li><a href="#snapshots" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Snapshots</a></li>
                    <li><a href="#importCSV" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">CSV import</a></li>
                    <li><a href="#emergency" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Emergency plan</a></li>
                    <li><a href="#accessibility" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Accessibility</a></li>
                    <li><a href="#groupSession" class="block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700">Group session</a></li>
                  </ul>
                </details>
              </ul>
            </details>
          </li>
          <li><a href="#study" class="nav-main-link block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700 font-semibold" data-section="study">Study</a></li>
          <li><a href="#program" class="nav-main-link block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700 font-semibold" data-section="program">Program</a></li>
          <li><a href="#culture" class="nav-main-link block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700 font-semibold" data-section="culture">Culture</a></li>
          <li><a href="#analysis" class="nav-main-link block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700 font-semibold" data-section="analysis">Analysis</a></li>
          <li><a href="#history" class="nav-main-link block px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-700 font-semibold" data-section="history">History</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Content -->
    <!-- Tools section: holds all existing cards and tools content -->
    <section id="tools" class="main-content-section space-y-6">
      <!-- Overview -->
      <section id="overview" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">How to use this guide</h2>
        <ol class="mt-3 list-decimal list-inside space-y-2 text-sm md:text-base">
          <li><b>Navigate:</b> Use the collapsible menu on the left to explore the guide. Each category (Overview, Step tools, Practice &amp; Review, Advanced tools) can be expanded or collapsed. Click a link to jump straight to that section.</li>
          <li><b>Top bar tools:</b> The header houses actions like printing/exporting or importing your work and backing up your progress. A small gear icon opens a settings panel where you can toggle compact mode, switch between alternate color palettes, enable private mode and choose a theme. Use these controls to tailor the guide to your preferences.</li>
          <li><b>Color‑coded marking:</b> On your first pass, simply read for flow. On subsequent passes, start marking text according to the color legend: begin with Problems → Solutions, then add Directions/Actions and Promises/Results. Later passes can include Warnings, Principles, Definitions, Prayers/Meditations, Inventory Questions and Step tags.</li>
          <li><b>Deepen your practice:</b> Explore the Step tools to work through Steps 4–12, and use the Practice &amp; Review tools (flashcards, check‑ins, analytics, tracker, reading plan, quiz and more) to reinforce your learning. Advanced tools provide powerful ways to search, drill, import data and collaborate.</li>
        </ol>
        <div class="mt-4 p-4 rounded-xl border bg-slate-50 text-slate-700 text-sm">Tip: Explore each section at your own pace—collapse menus when not in use to keep the interface clean. Use the settings gear to customize themes and palettes for comfort and accessibility.</div>
      </section>

      <!-- Colors -->
      <section id="colors" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl md:text-2xl font-bold">Color legend (highlighter)</h2>
            <p class="text-slate-600 text-sm mt-1">8 core categories. Click a hex code to copy. Margin codes help keep notes consistent.</p>
          </div>
          <div class="no-print">
            <button id="copyAllHex" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs hover:bg-slate-800 shadow">Copy all hexes</button>
          </div>
        </div>

        <!-- Palette container now uses a single column layout on all screen sizes
             to prevent cards from wrapping into multiple columns. Previously
             responsive classes like `sm:grid-cols-2 lg:grid-cols-3` caused
             cards to compress and hide text when the viewport was wide. By
             enforcing `grid-cols-1` the color legend cards will each span
             the full width of the container, preserving readability. -->
        <div id="palette" class="mt-4 grid grid-cols-1 gap-4"></div>

        <div class="mt-6 text-sm text-slate-600">
          Optional add‑ons: <span class="px-1.5 py-0.5 rounded bg-slate-100 border">Step Tags (S1…S12)</span>, 
          <span class="px-1.5 py-0.5 rounded bg-slate-100 border">Sponsor Tips (SPN)</span>, 
          <span class="px-1.5 py-0.5 rounded bg-slate-100 border">History (HIS)</span>
        </div>
      </section>

      <!-- Underline key -->
      <section id="underline" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Underline & markup key</h2>
        <div class="mt-3 grid md:grid-cols-2 gap-4 text-sm md:text-base">
          <div class="p-4 rounded-xl border">
            <div><span class="u-single">Single solid underline</span> → Action to take.</div>
            <div class="mt-2"><span class="u-double">Double solid underline</span> → Strong imperative / “must/never”.</div>
            <div class="mt-2"><span class="u-wavy">Wavy underline</span> → Warning / caution.</div>
            <div class="mt-2"><span class="u-dashed">Dashed underline</span> → Definition / concept.</div>
            <div class="mt-2"><span class="u-dotted">Dotted underline</span> → Question for inventory or meditation.</div>
          </div>
          <div class="p-4 rounded-xl border">
            <div>[Square brackets] → Qualifiers (if/when/except) that change meaning.</div>
            <div class="mt-2">(Parentheses) → Edition notes, cross‑refs, or step numbers (e.g., (S4), (S9)).</div>
            <div class="mt-2"><span class="px-1 rounded border">Box around a phrase</span> → Promise/result worth memorizing.</div>
            <div class="mt-2 text-slate-600 text-sm">Choose 2–3 underline types you’ll actually use. Consistency beats complexity.</div>
          </div>
        </div>
      </section>

      <!-- Symbols -->
      <section id="symbols" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Margin symbols (fast cues)</h2>
        <div class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">★</span> Promise</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">!</span> Warning / don’t skip</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">▶</span> Start of an instruction sequence</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">☑</span> Checklist item completed</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">?</span> Inventory question to answer later</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">Ⓟ</span> Prayer &nbsp; <span class="text-base">Ⓜ</span> Meditation</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">✦</span> Spiritual principle to practice today</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">↺</span> Repeat daily</div>
          <div class="flex items-center gap-2 p-3 border rounded-xl"><span class="text-base">⊕</span> Share with sponsee / meeting</div>
        </div>
      </section>

      <!-- What to look for -->
      <section id="lookfor" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">What to look for (by category)</h2>
        <ul class="mt-3 space-y-2 text-sm md:text-base">
          <li><b>Problems (Orange):</b> self‑centeredness, fear, dishonesty, resentment; “the way I used to manage life”; subtle self‑reliance.</li>
          <li><b>Solutions (Purple):</b> surrender, reliance on HP, inventory, confession, amends, service, continued practice.</li>
          <li><b>Directions (Blue):</b> sequences (before/then/next/followed by), checklists, precise instructions.</li>
          <li><b>Promises (Gold):</b> “we will/are/feel/know…”, sanity, freedom, usefulness, peace.</li>
          <li><b>Warnings (Magenta):</b> “if we… (don’t / insist / refuse) → trouble”; common detours; half‑measures.</li>
          <li><b>Definitions (Teal):</b> what alcoholism is/is not; spiritual experience vs. awakening; the purpose of each Step.</li>
          <li><b>Prayers/Meditations (Sky):</b> “we ask…”, “thy will…”, pause‑and‑ask moments.</li>
          <li><b>Inventory Questions (Green):</b> who/what/where was I selfish, dishonest, self‑seeking, frightened? what harms? what amends?</li>
        </ul>
      </section>

      <!-- Analog study framework -->
      <section id="analog" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Analog study framework (printable)</h2>
        <p class="text-slate-600 text-sm mt-1">Prefer studying from a physical book? Use this guide to replicate the digital color‑coding and annotation system in your own Big Book using pens and highlighters. Each category below corresponds to a color so you can quickly spot themes.</p>

        <!-- Color coding table for physical study -->
        <h3 class="mt-5 font-semibold">Color codes</h3>
        <div class="mt-2 overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-3 py-2 text-left font-medium text-slate-500 uppercase tracking-wide">Category</th>
                <th class="px-3 py-2 text-left font-medium text-slate-500 uppercase tracking-wide">Marker color</th>
                <th class="px-3 py-2 text-left font-medium text-slate-500 uppercase tracking-wide">What to mark</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-slate-200">
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">The Problem</td>
                <td class="px-3 py-2">Red/Pink</td>
                <td class="px-3 py-2 text-slate-700">Powerlessness, craving, obsession, unmanageability</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">The Solution</td>
                <td class="px-3 py-2">Blue</td>
                <td class="px-3 py-2 text-slate-700">Higher Power, spiritual awakening, reliance on God</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">The Program</td>
                <td class="px-3 py-2">Green</td>
                <td class="px-3 py-2 text-slate-700">The Twelve Steps and actions to practice them</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">The Result/Promises</td>
                <td class="px-3 py-2">Yellow</td>
                <td class="px-3 py-2 text-slate-700">Freedom from fear, peace of mind, new purpose</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">Personal Resonance</td>
                <td class="px-3 py-2">Purple</td>
                <td class="px-3 py-2 text-slate-700">“Aha!” moments or lines that speak to you personally</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">Spiritual Principles</td>
                <td class="px-3 py-2">Teal</td>
                <td class="px-3 py-2 text-slate-700">Virtues such as honesty, humility and willingness</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">Practical Actions</td>
                <td class="px-3 py-2">Orange</td>
                <td class="px-3 py-2 text-slate-700">Daily tasks like prayer, meditation and helping others</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">Disease Description</td>
                <td class="px-3 py-2">Coral</td>
                <td class="px-3 py-2 text-slate-700">Descriptions of the physical allergy and mental obsession</td>
              </tr>
              <tr>
                <td class="px-3 py-2 font-medium text-slate-900">Fellowship &amp; Support</td>
                <td class="px-3 py-2">Lime</td>
                <td class="px-3 py-2 text-slate-700">Mentions of sponsors, meetings or shared experience</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Margin and underline system for physical books -->
        <h3 class="mt-6 font-semibold">Margin &amp; underline symbols</h3>
        <ul class="mt-2 space-y-1 text-sm md:text-base">
          <li><b>Single underline:</b> Direct instruction or action to take.</li>
          <li><b>Double underline:</b> Strong imperative – “must” or “never”.</li>
          <li><b>Wavy underline:</b> Warnings, pitfalls or spiritual dangers.</li>
          <li><b>Dashed underline:</b> Definitions or important concepts.</li>
          <li><b>Dotted underline:</b> Inventory or meditation questions.</li>
          <li><b>* (asterisk):</b> Character defect such as resentment, fear or selfishness.</li>
          <li><b>[Square brackets]:</b> Link actions to promised results (if/when → then).</li>
          <li><b>cf. p. #:</b> Cross–reference other pages with related ideas.</li>
          <li><b>?</b> Question for discussion or further study.</li>
        </ul>

        <h3 class="mt-6 font-semibold">Suggested supplies</h3>
        <p class="mt-2 text-sm md:text-base text-slate-700">Gather a set of colored highlighters or pencils corresponding to the categories above, a fine‑tip pen for underlining, and a ruler if you like neat lines. Use the margins of your Big Book to jot brief summaries or symbols. Keep a separate notebook for longer reflections.</p>

        <div class="mt-4 p-4 rounded-xl border bg-slate-50 text-slate-700 text-sm">Tip: These colors and symbols mirror the digital guide. Feel free to adapt the palette or choose fewer colors to keep your system simple and consistent.</div>
      </section>

      <!-- Steps -->
      <section id="steps" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Step & practice mapping</h2>
        <div class="mt-3 grid sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm md:text-base">
          <div class="p-3 border rounded-xl"><b>S1–S3:</b> Admission, decision, turning.</div>
          <div class="p-3 border rounded-xl"><b>S4–S5:</b> Inventory & confession.</div>
          <div class="p-3 border rounded-xl"><b>S6–S7:</b> Willingness & humility.</div>
          <div class="p-3 border rounded-xl"><b>S8–S9:</b> Amends list & action.</div>
          <div class="p-3 border rounded-xl"><b>S10–S11:</b> Daily inventory, prayer, meditation.</div>
          <div class="p-3 border rounded-xl"><b>S12:</b> Carrying the message & practicing principles.</div>
        </div>
        <p class="mt-3 text-sm text-slate-600">Daily tools (label with <b>D</b>): D‑Pause‑Ask, D‑Spot‑Inventory, D‑Amends‑Prompt, D‑Prayer, D‑Meditation, D‑Service.</p>
      </section>

      <!-- Workflow -->
      <section id="workflow" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">A simple marking workflow</h2>
        <ol class="mt-3 list-decimal list-inside space-y-2 text-sm md:text-base">
          <li><b>Box</b> the central sentence of a paragraph (often the thesis).</li>
          <li><b>Highlight</b> each clause by category (colors above).</li>
          <li><b>Underline</b> the action words; <b>double‑underline</b> “must/never/always.”</li>
          <li>Add a <b>margin summary</b> (≤7 words) and one <b>symbol</b>.</li>
          <li>If it’s actionable, write a <b>today‑statement</b> (e.g., “Today I will call X and make an amends plan”).</li>
        </ol>
      </section>

      <!-- Checklist -->
      <section id="checklist" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Consistency checklist</h2>
        <div id="checklistItems" class="mt-3 grid md:grid-cols-2 gap-3 text-sm md:text-base"></div>
      </section>

      <!-- Custom codes -->
      <section id="custom" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Space for your custom codes</h2>
        <div class="mt-3 grid md:grid-cols-2 gap-4 text-sm md:text-base">
          <label class="block"><span class="text-xs uppercase tracking-wider text-slate-500">Color → Category</span>
            <textarea id="ccColor" class="mt-1 w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="e.g., Orange → Problem; Purple → Solution"></textarea>
          </label>
          <label class="block"><span class="text-xs uppercase tracking-wider text-slate-500">Underline style → Meaning</span>
            <textarea id="ccUnderline" class="mt-1 w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="e.g., Double → Must/imperative"></textarea>
          </label>
          <label class="block md:col-span-2"><span class="text-xs uppercase tracking-wider text-slate-500">Symbol → Meaning</span>
            <textarea id="ccSymbol" class="mt-1 w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="e.g., ★ → Promise; ! → Warning"></textarea>
          </label>
        </div>
      </section>

      <!-- Sampler -->
      <section id="sampler" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-xl md:text-2xl font-bold">Highlight sampler</h2>
          <div class="flex items-center gap-2">
            <button id="btnSpeakSample" class="no-print px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300" title="Read aloud">🔊</button>
            <button id="btnClearSample" class="no-print px-3 py-2 rounded-xl bg-white border text-xs hover:bg-slate-50">Clear</button>
          </div>
        </div>
        <div class="mt-3 grid md:grid-cols-[1fr,260px] gap-4">
          <div>
            <textarea id="sampleText" rows="5" class="w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 text-sm md:text-base" placeholder="Paste a line here and test colors & underline styles..."></textarea>
            <div id="sampleOut" class="mt-3 p-4 rounded-xl border text-sm md:text-base">
              <span class="text-slate-500">Your formatted text will preview here…</span>
            </div>

      <!-- Tag helper suggestions and guided filter controls -->
      <div id="tagHelper" class="mt-4 hidden">
        <h3 class="text-xs uppercase tracking-wider text-slate-500 mb-2">Tag suggestions</h3>
        <div id="tagList" class="space-y-2 text-sm"></div>
        <button id="btnApplyTags" class="mt-2 px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs hover:bg-indigo-500 shadow">Apply suggestions</button>
      </div>
      <div id="filterControls" class="mt-4 hidden">
        <h3 class="text-xs uppercase tracking-wider text-slate-500 mb-2">Guided filters</h3>
        <div id="filterBtns" class="flex flex-wrap gap-2"></div>
        <label class="flex items-center gap-2 mt-2 text-xs text-slate-600"><input id="toggleDim" type="checkbox" class="size-4"> <span>Dim non‑matches</span></label>
      </div>
          </div>
          <div class="space-y-3 text-sm">
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Category color</div>
              <select id="sampleColor" class="w-full p-2.5 rounded-xl border">
                <!-- options injected by JS -->
              </select>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Underline style</div>
              <select id="sampleUnderline" class="w-full p-2.5 rounded-xl border">
                <option value="">(none)</option>
                <option value="u-single">Single</option>
                <option value="u-double">Double</option>
                <option value="u-wavy">Wavy</option>
                <option value="u-dashed">Dashed</option>
                <option value="u-dotted">Dotted</option>
              </select>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Add box</div>
              <label class="flex items-center gap-2"><input id="sampleBox" type="checkbox" class="size-4"> <span>Box this phrase (promise/result)</span></label>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wider text-slate-500 mb-1">Quick insert</div>
              <div class="flex flex-wrap gap-2">
                <button data-insert="Today I will…" class="chip">Today I will…</button>
                <button data-insert="We ask…" class="chip">We ask…</button>
                <button data-insert="If I don’t…" class="chip">If I don’t…</button>
                <button data-insert="I was selfish/dishonest/self‑seeking/frightened." class="chip">Spot‑inventory</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Step 4 Worksheet Section -->
      <section id="step4" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 4 worksheet</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Quickly record your resentments, fears and sex conduct. Fill in the quick add form for each category and click Add. Your lists are stored in your browser. Export each category to CSV or all together to Markdown.</p>
        <!-- Resentments -->
        <div class="mb-6">
          <h3 class="font-semibold text-base md:text-lg mb-2">Resentments</h3>
          <div class="flex flex-wrap gap-2 items-end mb-2">
            <input id="resentWho" placeholder="Who/What" class="p-2 border rounded flex-1 text-sm" />
            <input id="resentCause" placeholder="Cause" class="p-2 border rounded flex-1 text-sm" />
            <input id="resentAffects" placeholder="Affects" class="p-2 border rounded flex-1 text-sm" />
            <input id="resentMyPart" placeholder="My part" class="p-2 border rounded flex-1 text-sm" />
            <button data-target="resentMyPart" class="mic-btn px-2 py-2 rounded-full bg-slate-200 text-slate-700 text-xs hover:bg-slate-300" title="Dictate"><span>🎤</span></button>
            <button id="btnAddResent" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs hover:bg-indigo-500 shadow">Add</button>
          </div>
          <div id="resentRows" class="space-y-2"></div>
          <div class="mt-2 flex gap-2 no-print">
            <button id="btnCSVResent" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs hover:bg-slate-800 shadow">Export CSV</button>
          </div>
        </div>
        <!-- Fears -->
        <div class="mb-6">
          <h3 class="font-semibold text-base md:text-lg mb-2">Fears</h3>
          <div class="flex flex-wrap gap-2 items-end mb-2">
            <input id="fearWho" placeholder="Who/What" class="p-2 border rounded flex-1 text-sm" />
            <input id="fearCause" placeholder="Cause" class="p-2 border rounded flex-1 text-sm" />
            <input id="fearAffects" placeholder="Affects" class="p-2 border rounded flex-1 text-sm" />
            <input id="fearMyPart" placeholder="My part" class="p-2 border rounded flex-1 text-sm" />
            <button data-target="fearMyPart" class="mic-btn px-2 py-2 rounded-full bg-slate-200 text-slate-700 text-xs hover:bg-slate-300" title="Dictate"><span>🎤</span></button>
            <button id="btnAddFear" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs hover:bg-indigo-500 shadow">Add</button>
          </div>
          <div id="fearRows" class="space-y-2"></div>
          <div class="mt-2 flex gap-2 no-print">
            <button id="btnCSVFear" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs hover:bg-slate-800 shadow">Export CSV</button>
          </div>
        </div>
        <!-- Sex Conduct -->
        <div>
          <h3 class="font-semibold text-base md:text-lg mb-2">Sex Conduct</h3>
          <div class="flex flex-wrap gap-2 items-end mb-2">
            <input id="sexWho" placeholder="Who/What" class="p-2 border rounded flex-1 text-sm" />
            <input id="sexCause" placeholder="Cause" class="p-2 border rounded flex-1 text-sm" />
            <input id="sexAffects" placeholder="Affects" class="p-2 border rounded flex-1 text-sm" />
            <input id="sexMyPart" placeholder="My part" class="p-2 border rounded flex-1 text-sm" />
            <button data-target="sexMyPart" class="mic-btn px-2 py-2 rounded-full bg-slate-200 text-slate-700 text-xs hover:bg-slate-300" title="Dictate"><span>🎤</span></button>
            <button id="btnAddSex" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs hover:bg-indigo-500 shadow">Add</button>
          </div>
          <div id="sexRows" class="space-y-2"></div>
          <div class="mt-2 flex gap-2 no-print">
            <button id="btnCSVSex" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs hover:bg-slate-800 shadow">Export CSV</button>
            <button id="btnExportStep4MD" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white text-xs hover:bg-slate-800 shadow">Export Markdown</button>
          </div>
        <!-- Streak heatmap -->
        <div id="heatmap" class="mt-6">
          <h3 class="font-semibold text-base md:text-lg mb-2">Daily streak</h3>
          <div id="streakGrid" class="grid grid-cols-7 gap-1"></div>
        </div>
        </div>
        <!-- Undo/Redo/Trash controls -->
        <div class="mt-4 flex gap-2 no-print">
          <button id="btnStep4Trash" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Trash</button>
        </div>
        </div>
      </section>

      <!-- Step 8/9 Amends Planner Section -->
      <section id="amends" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 8/9 amends planner</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Record amends you need to make, assess severity and readiness, and plan your next action. Entries persist in your browser.</p>
        <div class="flex flex-wrap gap-2 items-end mb-2">
          <input id="amendName" placeholder="Name / Situation" class="p-2 border rounded flex-1 text-sm" />
          <input id="amendHarm" placeholder="Harm / Issue" class="p-2 border rounded flex-1 text-sm" />
          <select id="amendSeverity" class="p-2 border rounded text-sm">
            <option value="Low">Low severity</option>
            <option value="Medium">Medium severity</option>
            <option value="High">High severity</option>
          </select>
          <select id="amendReadiness" class="p-2 border rounded text-sm">
            <option value="Not ready">Not ready</option>
            <option value="Willing">Willing</option>
            <option value="Ready">Ready</option>
          </select>
          <input id="amendObstacles" placeholder="Obstacles" class="p-2 border rounded flex-1 text-sm" />
          <input id="amendNext" placeholder="Next action" class="p-2 border rounded flex-1 text-sm" />
          <button id="btnAddAmend" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs hover:bg-indigo-500 shadow">Add</button>
        </div>
        <div id="amendRows" class="space-y-2"></div>
        <p class="mt-3 text-xs text-slate-500 italic">Always consult your sponsor before making an amends. Safety first.</p>
      </section>

      <!-- Flashcards Section -->
      <!-- Flashcards section visible by default (was hidden) -->
      <section id="flashcards" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Flashcards</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Review your key concepts and "My part" insights. Flip each card to reveal the answer.</p>
        <div id="flashcardArea" class="border rounded-xl p-6 text-center bg-white shadow-inner min-h-[120px] flex items-center justify-center"></div>
        <div class="mt-4 flex items-center justify-center gap-3 no-print">
          <button id="btnPrevCard" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs md:text-sm hover:bg-slate-300">Prev</button>
          <button id="btnFlipCard" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500">Flip</button>
          <button id="btnNextCard" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs md:text-sm hover:bg-slate-300">Next</button>
          <button id="btnExportCards" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800">Export CSV</button>
        </div>
        <p class="mt-2 text-xs text-slate-500 text-center">Cards generated from your Step‑4 “My part” phrases and definitions.</p>
      </section>

      <!-- Daily Check-ins Section -->
      <!-- Daily check‑ins section visible by default (was hidden) -->
      <section id="checkins" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Daily check‑ins</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Set an intention in the morning and review your day in the evening. Entries are stored per‑day and displayed as a streak.</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <h3 class="font-semibold text-sm md:text-base mb-1">Morning intention</h3>
            <textarea id="morningInput" rows="3" class="w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Today I intend to…"></textarea>
          </div>
          <div>
            <h3 class="font-semibold text-sm md:text-base mb-1">Evening review</h3>
            <textarea id="eveningInput" rows="3" class="w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Tonight I reflect on…"></textarea>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="btnSaveCheckin" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Save entry</button>
          <span id="streakBadge" class="hidden px-3 py-1 rounded-full bg-indigo-600 text-white text-xs"></span>
        </div>
        <div id="checkinHeatmap" class="grid grid-cols-7 gap-1 mt-4"></div>
      </section>

      <!-- Analytics Section -->
      <!-- Analytics section visible by default (was hidden) -->
      <section id="analytics" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Analytics</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Visualize your usage patterns. Data is stored locally and updated in real time.</p>
        <div id="analyticsContent" class="space-y-4"></div>
      </section>

      <!-- Compare excerpts Section -->
      <!-- Compare excerpts section visible by default (was hidden) -->
      <section id="compare" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Edition / Excerpt compare</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Paste two excerpts to see differences highlighted. Added words are green; removed words are red.</p>
        <div class="grid md:grid-cols-2 gap-4">
          <textarea id="compareA" rows="5" class="w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Excerpt A…"></textarea>
          <textarea id="compareB" rows="5" class="w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="Excerpt B…"></textarea>
        </div>
        <button id="btnCompare" class="mt-3 px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Compare</button>
        <div id="compareResult" class="mt-4 p-4 border rounded-xl bg-white overflow-auto text-sm"></div>
      </section>

      <!-- Palette Tuner Section -->
      <!-- Palette tuner section visible by default (was hidden) -->
      <section id="paletteTuner" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Palette tuner & CVD simulator</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Preview your palette under different filters and nudge hues to improve accessibility.</p>
        <div id="palettePreview" class="flex flex-wrap gap-3"></div>
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnFilterNone" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Normal</button>
          <button id="btnFilterProtan" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Protanopia</button>
          <button id="btnFilterDeutan" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Deuteranopia</button>
          <button id="btnFilterTritan" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Tritanopia</button>
          <button id="btnHueDown" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Hue –</button>
          <button id="btnHueUp" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Hue +</button>
          <button id="btnResetPalette" class="px-3 py-1.5 rounded-xl bg-slate-200 text-slate-700 text-xs hover:bg-slate-300">Reset</button>
        </div>
      </section>

      <!-- Promise Tracker Section -->
      <!-- Removed hidden class so the promise tracker is visible and the navigation link works properly -->
      <section id="promises" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Promise tracker</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Mark promises you’ve experienced and journal your reflections. Track your progress as you go.</p>
        <div id="promiseList" class="space-y-2"></div>
        <div class="mt-3 flex items-end gap-2">
          <input id="newPromise" placeholder="Add a new promise…" class="flex-1 p-2 border rounded text-sm" />
          <button id="btnAddPromise" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Add</button>
        </div>
        <div class="mt-4">
          <div class="relative h-2 bg-slate-200 rounded-full overflow-hidden">
            <div id="promiseProgress" class="absolute h-full bg-indigo-600 rounded-full" style="width:0%"></div>
          </div>
          <p class="mt-1 text-xs text-slate-600"><span id="promiseCount">0</span>/<span id="promiseTotal">0</span> promises completed</p>
        </div>
      </section>

      <!-- Group Session Section -->
      <!-- Step 10 Spot Inventory -->
      <section id="step10" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 10 Spot Inventory</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Use this tool to quickly log inventory entries during your day.</p>
        <button id="btnAddSpot" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow mb-3">New Entry</button>
        <div id="spotForm" class="space-y-2 mb-4 hidden">
          <input id="spotWhat" type="text" placeholder="What happened?" class="w-full p-2 border rounded text-sm" />
          <input id="spotPart" type="text" placeholder="My part" class="w-full p-2 border rounded text-sm" />
          <input id="spotResentment" type="text" placeholder="Resentment?" class="w-full p-2 border rounded text-sm" />
          <input id="spotAction" type="text" placeholder="Next right action" class="w-full p-2 border rounded text-sm" />
          <div class="flex gap-2">
            <button id="btnSaveSpot" class="flex-1 px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Save</button>
            <button id="btnCancelSpot" class="flex-1 px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs md:text-sm hover:bg-slate-300 shadow">Cancel</button>
          </div>
        </div>
        <div id="spotList" class="space-y-2"></div>
      </section>

      <!-- Step 11 Prayer / Meditation Planner -->
      <section id="step11" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 11 Prayer &amp; Meditation Planner</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Define your morning and evening practices, set reminders and log insights.</p>
        <div class="mb-4">
          <h3 class="font-semibold text-sm md:text-base">Morning practices</h3>
          <div class="flex gap-2 mt-1">
            <input id="morningPracticeInput" type="text" placeholder="Add morning practice" class="flex-1 p-2 border rounded text-sm" />
            <button id="btnAddMorning" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Add</button>
          </div>
          <ul id="morningPractices" class="mt-2 space-y-1 text-xs md:text-sm"></ul>
        </div>
        <div class="mb-4">
          <h3 class="font-semibold text-sm md:text-base">Evening practices</h3>
          <div class="flex gap-2 mt-1">
            <input id="eveningPracticeInput" type="text" placeholder="Add evening practice" class="flex-1 p-2 border rounded text-sm" />
            <button id="btnAddEvening" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Add</button>
          </div>
          <ul id="eveningPractices" class="mt-2 space-y-1 text-xs md:text-sm"></ul>
        </div>
        <div class="mb-4">
          <h3 class="font-semibold text-sm md:text-base">Insights</h3>
          <div class="flex gap-2 mt-1">
            <input id="insightInput" type="text" placeholder="Log insight" class="flex-1 p-2 border rounded text-sm" />
            <button id="btnAddInsight" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Add</button>
          </div>
          <ul id="insightList" class="mt-2 space-y-1 text-xs md:text-sm"></ul>
        </div>
        <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs md:text-sm block mb-1">Morning reminder time</label>
            <input id="morningTime" type="time" class="w-full p-2 border rounded text-sm" />
          </div>
          <div>
            <label class="text-xs md:text-sm block mb-1">Evening reminder time</label>
            <input id="eveningTime" type="time" class="w-full p-2 border rounded text-sm" />
          </div>
        </div>
        <button id="btnSetReminders" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Set reminders</button>
      </section>

      <!-- Find Everything Search -->
      <section id="searchAll" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Find Everything</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Search across Step 4, Amends, Check‑ins and Promises.</p>
        <input id="searchInput" type="text" placeholder="Type to search…" class="w-full p-2 border rounded text-sm mb-3" />
        <ul id="searchResults" class="space-y-1 text-xs md:text-sm"></ul>
      </section>

      <!-- Tagging Drill -->
      <section id="drill" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Tagging Drill</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Paste a paragraph and practice tagging sentences with categories.</p>
        <textarea id="drillText" rows="3" placeholder="Paste text here…" class="w-full p-2 border rounded text-sm mb-3"></textarea>
        <button id="btnStartDrill" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow mb-3">Start drill</button>
        <div id="drillGame" class="hidden space-y-2">
          <p id="drillSentence" class="text-sm md:text-base italic"></p>
          <select id="drillSelect" class="p-2 border rounded text-sm">
            <option value="PR">Problem</option>
            <option value="SO">Solution</option>
            <option value="ACT">Action</option>
            <option value="PRO">Promise</option>
            <option value="WARN">Warning</option>
            <option value="DEF">Definition</option>
            <option value="PRAY">Prayer</option>
            <option value="Q">Question</option>
          </select>
          <button id="btnSubmitDrill" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Submit</button>
          <div id="drillFeedback" class="text-xs md:text-sm text-green-700"></div>
          <div id="drillScore" class="text-xs md:text-sm font-semibold"></div>
        </div>
      </section>

      <!-- Group session section visible by default (was hidden) -->
      <section id="groupSession" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Group session tools</h2>
        <p class="text-slate-600 text-sm md:text-base mb-4">Manage a speaking queue and timers for group discussions. People added here remain local to your device until cleared.</p>
        <div class="flex flex-wrap gap-2 items-end mb-3">
          <input id="newSpeaker" placeholder="Add person…" class="flex-1 p-2 border rounded text-sm" />
          <button id="btnAddSpeaker" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Add</button>
          <button id="btnExportSpeakers" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800 shadow">Export CSV</button>
        </div>
        <ul id="speakerList" class="space-y-2"></ul>
      </section>

      <!-- Step 5 Session Helper -->
      <section id="step5" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 5 Session Helper</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Run a timed 15‑minute sharing session. You’ll be gently notified at 5, 10 and 15 minutes. Afterwards, jot down anything you missed.</p>
        <button id="btnStartSession5" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Start session</button>
        <div id="session5Timer" class="mt-3 text-lg font-bold"></div>
        <div id="session5Controls" class="mt-3 hidden">
          <textarea id="session5Reflection" rows="3" class="w-full p-3 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 text-sm" placeholder="What did I miss?"></textarea>
          <button id="btnSaveSession5" class="mt-2 px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Save reflection</button>
        </div>
        <ul id="session5Log" class="mt-3 space-y-2 text-xs md:text-sm"></ul>
      </section>

      <!-- Step 6/7 Defect → Principle Mapper -->
      <section id="defects" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 6/7 Defect → Principle Mapper</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Select a common defect to see suggested opposing principles and a personalized Step‑7 prayer.</p>
        <select id="defectSelect" class="w-full p-2 border rounded text-sm mb-2"></select>
        <div id="principleOutput" class="text-sm text-slate-700 mb-2"></div>
        <div id="prayerOutput" class="text-sm font-semibold text-slate-800"></div>
      </section>

      <!-- Step 12 Service Tracker -->
      <section id="service" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Step 12 Service Tracker</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Log simple acts of service and see your totals.</p>
        <div class="flex flex-wrap gap-2 mb-3">
          <button class="serviceBtn px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow" data-type="chair">Chair</button>
          <button class="serviceBtn px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow" data-type="greet">Greet</button>
          <button class="serviceBtn px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow" data-type="call">Sponsor call</button>
        </div>
        <div id="serviceTotals" class="text-sm text-slate-600 mb-2"></div>
        <ul id="serviceLog" class="space-y-2 text-xs md:text-sm"></ul>
      </section>

      <!-- Reading Plan Builder -->
      <section id="readingPlan" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Reading Plan Builder</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Create a 30‑day reading plan with titles or topics. Check them off as you go and export to an .ics calendar file.</p>
        <div class="flex gap-2 mb-2">
          <input id="readingInput" type="text" placeholder="Add title/topic" class="flex-1 p-2 border rounded text-sm" />
          <button id="btnAddReading" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Add</button>
        </div>
        <ul id="readingList" class="space-y-1 text-sm md:text-base mb-2"></ul>
        <div class="w-full bg-slate-200 rounded-full h-3">
          <div id="readingProgress" class="bg-indigo-600 h-3 rounded-full" style="width:0%"></div>
        </div>
        <div id="readingProgressText" class="text-xs text-slate-600 mt-1"></div>
        <button id="btnExportReadingIcs" class="mt-3 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800 shadow">Export .ics</button>
      </section>

      <!-- Recall Quiz from Notes -->
      <section id="quiz" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Recall Quiz from Notes</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Auto‑generate fill‑in‑the‑blank questions from your Step‑4 “My part” phrases.</p>
        <button id="btnGenerateQuiz" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow mb-3">Generate quiz</button>
        <div id="quizArea" class="space-y-4 text-sm md:text-base"></div>
        <button id="btnExportQuizCSV" class="mt-2 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs md:text-sm hover:bg-slate-800 shadow">Export CSV</button>
      </section>

      <!-- Version Snapshots & Diffing -->
      <section id="snapshots" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Version Snapshots</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Save a snapshot of your data and compare two snapshots for differences.</p>
        <button id="btnSaveSnapshot" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow mb-2">Save snapshot</button>
        <div id="snapshotList" class="space-y-1 text-xs md:text-sm mb-3"></div>
        <div id="diffArea" class="text-xs md:text-sm text-slate-700"></div>
      </section>

      <!-- CSV Import -->
      <section id="importCSV" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">CSV Import</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Import Step‑4 or Amends data from a CSV file.</p>
        <div class="flex flex-wrap gap-2 items-end mb-2">
          <select id="csvTarget" class="p-2 border rounded text-sm">
            <option value="resent">Step 4 — Resentments</option>
            <option value="fears">Step 4 — Fears</option>
            <option value="sex">Step 4 — Sex Conduct</option>
            <option value="amends">Step 8/9 — Amends</option>
          </select>
          <label for="fileImportCSV" class="px-3 py-2 rounded-xl bg-white border text-xs md:text-sm hover:bg-slate-50 cursor-pointer shadow">Choose CSV</label>
          <input id="fileImportCSV" type="file" accept=".csv" class="hidden" />
          <button id="btnImportCSV" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Import</button>
        </div>
      </section>

      <!-- Emergency Plan Card -->
      <section id="emergency" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Emergency Plan</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Define your urge protocol and use the grounding timer when cravings hit.</p>
        <textarea id="emCallList" rows="2" class="w-full p-2 border rounded text-sm mb-2" placeholder="Call list (comma‑separated names/numbers)"></textarea>
        <textarea id="emPrayer" rows="2" class="w-full p-2 border rounded text-sm mb-2" placeholder="Prayer / mantra"></textarea>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
          <input id="emAction1" type="text" placeholder="Action 1" class="p-2 border rounded text-sm" />
          <input id="emAction2" type="text" placeholder="Action 2" class="p-2 border rounded text-sm" />
          <input id="emAction3" type="text" placeholder="Action 3" class="p-2 border rounded text-sm" />
        </div>
        <button id="btnStartEmergency" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs md:text-sm hover:bg-indigo-500 shadow">Start 3‑min timer</button>
        <div id="emCountdown" class="mt-2 text-2xl font-bold text-indigo-700"></div>
      </section>

      <!-- Accessibility Options -->
      <section id="accessibility" class="card bg-white/80 backdrop-blur border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold mb-2">Accessibility Options</h2>
        <p class="text-slate-600 text-sm md:text-base mb-3">Adjust the font size and enable high‑contrast mode for better readability.</p>
        <div class="flex items-center gap-2 mb-3">
          <label for="fontSizeSlider" class="text-sm">Font size:</label>
          <input id="fontSizeSlider" type="range" min="14" max="22" value="16" class="flex-1" />
          <span id="fontSizeValue" class="text-sm">16px</span>
        </div>
        <div class="flex items-center gap-2">
          <input id="toggleHighContrast" type="checkbox" class="size-4" />
          <label for="toggleHighContrast" class="text-sm">High contrast mode</label>
        </div>
      </section>

      <footer class="text-center text-xs text-slate-500 pb-6">This is a tool, not a test. If your page looks like a rainbow and you can’t tell what to do today, simplify your scheme. The purpose is transformation, not decoration.</footer>

    </section> <!-- end of Tools content -->
      
    <!-- Removed the separate Home section. The Tools section now serves as the default landing content. -->

    <!-- Study section placeholder -->
    <section id="study" class="main-content-section hidden space-y-6">
      <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Study</h2>
        <p class="mt-3 text-sm md:text-base text-slate-700">The Study section is coming soon. Stay tuned for guided readings and exercises.</p>
      </section>
    </section>

    <!-- Program section placeholder -->
    <section id="program" class="main-content-section hidden space-y-6">
      <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Program</h2>
        <p class="mt-3 text-sm md:text-base text-slate-700">The Program section is under construction. Content will be added here in the future.</p>
      </section>
    </section>

    <!-- Culture section: populated with selected content from AA Slogans and AA Language -->
    <section id="culture" class="main-content-section hidden space-y-6">
      <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">AA Slogans</h2>
        <p class="mt-3 text-sm md:text-base text-slate-700">AA slogans are concise expressions of wisdom that help members remember and apply the program’s core principles. Below are a few of the most widely used slogans along with their meaning:</p>
        <div class="mt-4 space-y-4 text-sm md:text-base text-slate-700">
          <div>
            <h3 class="font-semibold text-indigo-700">One&nbsp;Day&nbsp;at&nbsp;a&nbsp;Time</h3>
            <p>Focuses on staying sober for just today, easing anxiety about a lifetime of abstinence and encouraging mindful, manageable actions.</p>
          </div>
          <div>
            <h3 class="font-semibold text-green-700">Easy&nbsp;Does&nbsp;It</h3>
            <p>Reminds us to practice patience and not rush the recovery process; progress is gradual and sustainable.</p>
          </div>
          <div>
            <h3 class="font-semibold text-teal-700">Let&nbsp;Go&nbsp;and&nbsp;Let&nbsp;God</h3>
            <p>Encourages surrendering control over things beyond our power and trusting a Higher Power (however one understands it).</p>
          </div>
          <div>
            <h3 class="font-semibold text-lime-700">Progress,&nbsp;Not&nbsp;Perfection</h3>
            <p>Emphasizes continuous improvement rather than striving for an unattainable ideal of flawlessness.</p>
          </div>
          <div>
            <h3 class="font-semibold text-yellow-700">Keep&nbsp;It&nbsp;Simple</h3>
            <p>Urges members not to overcomplicate recovery—stick to the basics of the program and avoid overthinking.</p>
          </div>
          <div>
            <h3 class="font-semibold text-orange-700">Other&nbsp;Key&nbsp;Slogans</h3>
            <p class="mt-1">First&nbsp;Things&nbsp;First; Nothing&nbsp;Changes&nbsp;if&nbsp;Nothing&nbsp;Changes; Faith&nbsp;Without&nbsp;Works&nbsp;Is&nbsp;Dead; I&nbsp;Am&nbsp;an&nbsp;Alcoholic; This&nbsp;Too&nbsp;Shall&nbsp;Pass; To&nbsp;Thine&nbsp;Own&nbsp;Self&nbsp;Be&nbsp;True; Keep&nbsp;Coming&nbsp;Back; It&nbsp;Works&nbsp;if&nbsp;You&nbsp;Work&nbsp;It; Stick&nbsp;With&nbsp;the&nbsp;Winners. These succinct reminders distill complex principles into memorable phrases.</p>
          </div>
        </div>
      </section>
      <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">AA Language Guide</h2>
        <p class="mt-3 text-sm md:text-base text-slate-700">The AA fellowship has its own lexicon of acronyms and insider phrases that act as mnemonic tools and shorthand for its concepts. Here are a few examples:</p>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left text-sm md:text-base border-collapse">
            <thead>
              <tr>
                <th class="border px-3 py-2 bg-slate-50 text-slate-700 font-semibold">Acronym</th>
                <th class="border px-3 py-2 bg-slate-50 text-slate-700 font-semibold">Meanings</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
              <tr>
                <td class="px-3 py-2">AA</td>
                <td class="px-3 py-2">Absolute Abstinence; Attitude Adjustment; Altruistic Action</td>
              </tr>
              <tr>
                <td class="px-3 py-2">ABC</td>
                <td class="px-3 py-2">Acceptance, Belief, Change; Ashtrays, Broom, Coffee</td>
              </tr>
              <tr>
                <td class="px-3 py-2">ACTION</td>
                <td class="px-3 py-2">Any Change Toward Improving One’s Nature; Any Change To Improve Our Natures</td>
              </tr>
              <tr>
                <td class="px-3 py-2">HALT</td>
                <td class="px-3 py-2">Hungry, Angry, Lonely, Tired — a reminder to check basic needs before reacting.</td>
              </tr>
              <tr>
                <td class="px-3 py-2">HOW</td>
                <td class="px-3 py-2">Honesty, Open‑mindedness, Willingness — key attitudes for recovery.</td>
              </tr>
            <!-- Additional examples from the AA lexicon -->
            <tr>
              <td class="px-3 py-2">FEAR</td>
              <td class="px-3 py-2">False Evidence Appearing Real; Face Everything And Recover</td>
            </tr>
            <tr>
              <td class="px-3 py-2">GOD</td>
              <td class="px-3 py-2">Good Orderly Direction; Gift Of Desperation</td>
            </tr>
            <tr>
              <td class="px-3 py-2">THINK</td>
              <td class="px-3 py-2">The Happiness I Never Knew; Try Honesty It Never Kills</td>
            </tr>
            <tr>
              <td class="px-3 py-2">KISS</td>
              <td class="px-3 py-2">Keep It Simple (and Sane); Keep It Spiritually Simple</td>
            </tr>
            <tr>
              <td class="px-3 py-2">YET</td>
              <td class="px-3 py-2">You’re Eligible Too — a reminder that relapse can happen to anyone</td>
            </tr>
            </tbody>
          </table>
        </div>
        <p class="mt-4 text-sm md:text-base text-slate-700">There are dozens more acronyms (e.g., GOD: Good Orderly Direction, FEAR: False Evidence Appearing Real) and insider phrases (e.g., “Keep coming back,” “Easy does it,” “One day at a time”). These shorthand expressions serve as quick reminders of the program’s principles and are often heard in meetings. For a deeper dive into the rich language of AA, consult official literature or experienced members.</p>
      </section>

    <!-- Essential phrases card -->
    <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
      <h2 class="text-xl md:text-2xl font-bold">Essential AA Phrases</h2>
      <p class="mt-3 text-sm md:text-base text-slate-700">Beyond acronyms and slogans, Alcoholics Anonymous is rich with phrases that capture hard‑won wisdom. These sayings are heard in meetings and day‑to‑day recovery conversations. A handful of memorable examples include:</p>
      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-left text-sm md:text-base border-collapse">
          <thead>
            <tr>
              <th class="border px-3 py-2 bg-slate-50 text-slate-700 font-semibold">Phrase / Term</th>
              <th class="border px-3 py-2 bg-slate-50 text-slate-700 font-semibold">Meaning and Usage</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <tr>
              <td class="px-3 py-2">Think, Think, Think</td>
              <td class="px-3 py-2">Encourages reflection and consideration of consequences before acting impulsively.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">Do the next right thing</td>
              <td class="px-3 py-2">Practical guidance for daily living: take immediate ethical actions even when the bigger picture is unclear.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">Fake it till you make it</td>
              <td class="px-3 py-2">Adopting recovery behaviours even without conviction can eventually lead to genuine change.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">Life on life’s terms</td>
              <td class="px-3 py-2">Accept reality as it is instead of trying to control situations beyond one’s power.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">One drink is too many, and a thousand is never enough</td>
              <td class="px-3 py-2">Reflects the powerlessness at the core of alcoholism: even a single drink can trigger a relapse.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">Attitude of gratitude</td>
              <td class="px-3 py-2">Fosters a positive outlook by focusing on gratitude for sobriety and daily blessings.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">Change is a process, not an event</td>
              <td class="px-3 py-2">Reinforces the ongoing, continuous nature of recovery and personal growth.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">You are not responsible for your first thought, but you are responsible for your first action</td>
              <td class="px-3 py-2">Distinguishes between intrusive thoughts or urges and conscious choices, empowering individuals to choose differently.</td>
            </tr>
            <tr>
              <td class="px-3 py-2">It’s a simple program for complicated people</td>
              <td class="px-3 py-2">Acknowledges that while members may feel complex and conflicted, AA’s principles remain straightforward and effective.</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="mt-4 text-sm md:text-base text-slate-700">These are just a few of the sayings you might hear in meetings. Countless other expressions — from “Ninety in Ninety” to “Turn it over” — circulate among members and serve as quick reminders to stay grounded in recovery.</p>
    </section>
    </section>

    <!-- Analysis section placeholder -->
    <section id="analysis" class="main-content-section hidden space-y-6">
      <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">Analysis</h2>
        <p class="mt-3 text-sm md:text-base text-slate-700">Analytical tools and insights will be available here soon. This section is currently under construction.</p>
      </section>
    </section>

    <!-- History section placeholder -->
    <section id="history" class="main-content-section hidden space-y-6">
      <section class="card border border-slate-200 rounded-2xl p-5 md:p-7 shadow">
        <h2 class="text-xl md:text-2xl font-bold">History</h2>
        <p class="mt-3 text-sm md:text-base text-slate-700">Historical context and background information on the Big Book and the AA movement will appear here in future updates.</p>
      </section>
    </section>

      <!-- Floating button to quickly open Step 10 inventory -->
      <button id="btnSpotWidget" class="fixed bottom-4 right-4 md:bottom-6 md:right-6 bg-indigo-600 text-white rounded-full shadow-lg p-3 no-print z-40">10</button>

      <!-- Meeting mode modal -->
      <div id="meetingModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm text-center">
          <h3 class="text-lg font-bold mb-3">Meeting Mode</h3>
          <p class="text-sm mb-2">Choose a timer length:</p>
          <div class="flex justify-center gap-2 mb-3">
            <button data-time="2" class="timerBtn px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">2 min</button>
            <button data-time="5" class="timerBtn px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">5 min</button>
            <button data-time="10" class="timerBtn px-3 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">10 min</button>
          </div>
          <div class="mb-3">
            <h4 class="font-semibold text-base">Topic of the day</h4>
            <div id="randomTopic" class="mt-1 text-sm text-slate-700 italic"></div>
          </div>
          <div class="mb-3">
            <h4 class="font-semibold text-base">Prayer / Meditation</h4>
            <div id="prayerText" class="mt-1 text-sm text-slate-700 italic"></div>
          </div>
          <div class="flex justify-center gap-3 mt-4">
            <button id="btnStartTimer" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm hover:bg-indigo-500">Start</button>
            <button id="btnCloseMeeting" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-700 text-sm hover:bg-slate-300">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Timer countdown overlay -->
      <div id="timerOverlay" class="fixed inset-0 bg-black/80 text-white flex items-center justify-center text-5xl font-bold z-50 hidden"></div>

      <!-- Command palette overlay -->
      <div id="commandPalette" class="fixed inset-0 bg-black/50 flex items-start justify-center pt-24 z-50 hidden">
        <div class="bg-white rounded-xl w-[90%] max-w-lg p-4 shadow-lg">
          <input id="cmdInput" type="text" placeholder="Type a command or jump to section…" class="w-full p-2 border rounded mb-3 outline-none" />
          <ul id="cmdList" class="max-h-60 overflow-y-auto"></ul>
        </div>
      </div>

      <!-- Trash drawer modal -->
      <div id="trashModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 w-[90%] max-w-md">
          <h3 class="text-lg font-bold mb-3">Trash</h3>
          <div id="trashList" class="space-y-2 max-h-60 overflow-y-auto"></div>
          <div class="flex justify-end gap-2 mt-3">
            <button id="btnEmptyTrash" class="px-3 py-2 rounded-xl bg-red-600 text-white text-sm hover:bg-red-500">Empty</button>
            <button id="btnCloseTrash" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-sm hover:bg-slate-300">Close</button>
          </div>
        </div>
      </div>

      <!-- QR code modal -->
      <div id="qrModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 w-[90%] max-w-sm text-center">
          <h3 class="text-lg font-bold mb-3">Sponsor QR</h3>
          <img id="qrImage" src="" alt="QR code" class="mx-auto mb-3 w-40 h-40" />
          <button id="btnCloseQR" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-700 text-sm hover:bg-slate-300">Close</button>
        </div>
      </div>
    </section>
  </main>

    <!-- Settings Modal (Gear) -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
      <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-xl">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-700">Settings</h3>
          <button id="settingsClose" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
        </div>
        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <input id="toggleCompact" type="checkbox" class="size-4" />
            <label for="toggleCompact" class="text-sm text-slate-700">Compact</label>
          </div>
          <div class="flex items-center gap-3">
            <input id="toggleAlt" type="checkbox" class="size-4" />
            <label for="toggleAlt" class="text-sm text-slate-700">Alt palette</label>
          </div>
          <div class="flex items-center gap-3">
            <input id="togglePrivate" type="checkbox" class="size-4" />
            <label for="togglePrivate" class="text-sm text-slate-700">Private</label>
          </div>
          <div class="flex items-center gap-3">
            <label for="themeSelect" class="text-sm text-slate-700">Theme</label>
            <select id="themeSelect" class="flex-1 text-sm border rounded p-1">
              <option value="default">Blue</option>
              <option value="minimal">Minimal</option>
              <option value="parchment">Parchment</option>
            </select>
          </div>
        </div>
      </div>
    </div>

  <!-- Global footer -->
  <footer class="text-center text-xs text-slate-500 py-4">
    <div>&copy; <span id="currentYear"></span> BigBook.study. Developed by <a href="mailto:Info@Manpasand.com" class="underline">Info@Manpasand.com</a></div>
  </footer>

  <script>
    // ===== Data =====
    const PALETTE_BASE = [
      { name: 'Problem / Self‑will / Old Ideas', hex: '#F97316', code: 'PR', look: 'Admissions of powerlessness, selfishness, self‑pity, fear, resentment, control, dishonesty.' },
      { name: 'Solution / Principles / Ideals', hex: '#7C3AED', code: 'SO', look: 'Reliance on a Higher Power, honesty, willingness, humility, service, love, tolerance.' },
      { name: 'Directions / Actions (Things to Do)', hex: '#2563EB', code: 'ACT', look: 'Clear instructions, sequences, checklists, verbs (admit, decide, list, confess, make amends, continue, pray).' },
      { name: 'Promises / Results (What Happens If)', hex: '#F59E0B', code: 'PRO', look: 'Outcomes and freedoms that follow action, signs of spiritual awakening, sanity restored.' },
      { name: 'Warnings / Cautions / Consequences', hex: '#D946EF', code: 'WARN', look: 'If we don’t…, relapse patterns, common pitfalls, self‑deception.' },
      { name: 'Definitions / Concepts / Big Ideas', hex: '#14B8A6', code: 'DEF', look: 'Defines alcoholism, spiritual experience, inventory, amends; distinctions and key terms.' },
      { name: 'Prayers & Meditations', hex: '#0EA5E9', code: 'PRAY', look: 'Explicit or implied prayers, meditative directions, requests of a Higher Power.' },
      { name: 'Inventory Questions / Self‑Examination', hex: '#22C55E', code: 'Q', look: 'Any line that becomes a question about motives, fears, harms, defects, amends, or daily practice.' },
    ];

    // Slightly tweaked alt palette (friendly for many CVD users — avoids close hues)
    const PALETTE_ALT = [
      { name: 'Problem / Self‑will / Old Ideas', hex: '#FB923C', code: 'PR', look: PALETTE_BASE[0].look },
      { name: 'Solution / Principles / Ideals', hex: '#8B5CF6', code: 'SO', look: PALETTE_BASE[1].look },
      { name: 'Directions / Actions (Things to Do)', hex: '#3B82F6', code: 'ACT', look: PALETTE_BASE[2].look },
      { name: 'Promises / Results (What Happens If)', hex: '#FBBF24', code: 'PRO', look: PALETTE_BASE[3].look },
      { name: 'Warnings / Cautions / Consequences', hex: '#EC4899', code: 'WARN', look: PALETTE_BASE[4].look },
      { name: 'Definitions / Concepts / Big Ideas', hex: '#10B981', code: 'DEF', look: PALETTE_BASE[5].look },
      { name: 'Prayers & Meditations', hex: '#06B6D4', code: 'PRAY', look: PALETTE_BASE[6].look },
      { name: 'Inventory Questions / Self‑Examination', hex: '#4ADE80', code: 'Q', look: PALETTE_BASE[7].look },
    ];

    // Store original palette copies for hue shifting
    const ORIG_PALETTE_BASE = JSON.parse(JSON.stringify(PALETTE_BASE));
    const ORIG_PALETTE_ALT = JSON.parse(JSON.stringify(PALETTE_ALT));

    const CHECK_ITEMS = [
      'I use the same 8 colors every time.',
      'I limit myself to 2–3 underline styles.',
      'Every marked line has a margin code (PR, ACT, PRO, etc.).',
      'I tag Steps only when it’s truly step‑specific.',
      'I write a one‑line takeaway per page.',
      'I can explain my marks to a newcomer.'
    ];

    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const LS_KEY = 'bb_highlight_guide_v1';

    // Additional localStorage keys
    const LS_CHECKINS = 'bb_checkins_v1';
    const LS_PROMISES = 'bb_promises_v1';
    const LS_THEME = 'bb_theme_v1';
    const LS_PRIVATE = 'bb_private_v1';
    const LS_UNDER_USAGE = 'bb_underline_usage_v1';
    const LS_PALETTE_SHIFT = 'bb_palette_shift_v1';
    const LS_PALETTE_FILTER = 'bb_palette_filter_v1';
    // New storage keys for additional tools
    const LS_STEP10 = 'bb_step10_v1';
    const LS_STEP11 = 'bb_step11_v1';

    function saveState(){
      const state = {
        compact: $('#toggleCompact').checked,
        alt: $('#toggleAlt').checked,
        checklist: $$('#checklistItems input[type=checkbox]').map(i => i.checked),
        ccColor: $('#ccColor').value,
        ccUnderline: $('#ccUnderline').value,
        ccSymbol: $('#ccSymbol').value,
      };
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const s = JSON.parse(raw);
        $('#toggleCompact').checked = !!s.compact;
        $('#toggleAlt').checked = !!s.alt;
        if(s.checklist){ $$('#checklistItems input[type=checkbox]').forEach((i,idx)=> i.checked = !!s.checklist[idx]); }
        if(typeof s.ccColor === 'string') $('#ccColor').value = s.ccColor;
        if(typeof s.ccUnderline === 'string') $('#ccUnderline').value = s.ccUnderline;
        if(typeof s.ccSymbol === 'string') $('#ccSymbol').value = s.ccSymbol;
        document.documentElement.classList.toggle('text-[15px]', !!s.compact);
        renderPalette();
      }catch(e){ console.warn('loadState', e); }
    }

    function copy(text){
      navigator.clipboard.writeText(text).then(()=>{
        toast('Copied to clipboard');
      }).catch(()=>{
        alert(text);
      })
    }

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-3 py-2 rounded-xl shadow text-sm';
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 1400);
    }

    function currentPalette(){
      return $('#toggleAlt').checked ? PALETTE_ALT : PALETTE_BASE;
    }

    function renderPalette(){
      const wrap = $('#palette');
      wrap.innerHTML = '';
      const pal = currentPalette();
      pal.forEach((p, idx)=>{
        const card = document.createElement('div');
        card.className = 'group border rounded-2xl p-4 bg-white shadow-sm hover:shadow-md transition-shadow';
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="size-10 rounded-xl border shadow-inner" style="background:${p.hex}"></div>
            <div class="min-w-0">
              <div class="font-semibold text-sm md:text-base truncate">${p.name}</div>
              <div class="text-xs text-slate-500">Margin: <b>${p.code}</b></div>
            </div>
            <button class="ml-auto px-2 py-1 rounded-lg bg-slate-900 text-white text-xs hover:bg-slate-800" data-hex="${p.hex}"> ${p.hex} </button>
          </div>
          <p class="mt-3 text-sm text-slate-700">${p.look}</p>
        `;
        wrap.appendChild(card);
      });
      // button copy
      wrap.querySelectorAll('button[data-hex]').forEach(btn=>{
        btn.addEventListener('click', ()=> copy(btn.getAttribute('data-hex')));
      });
      // sampler color options
      const sel = $('#sampleColor'); sel.innerHTML = '';
      pal.forEach((p,i)=>{
        const o = document.createElement('option');
        o.value = p.hex; o.textContent = `${p.code} — ${p.name}`; sel.appendChild(o);
      });
    }

    function renderChecklist(){
      const box = $('#checklistItems');
      box.innerHTML = '';
      CHECK_ITEMS.forEach((txt, i)=>{
        const id = 'chk_'+i;
        const row = document.createElement('label');
        row.className = 'flex items-start gap-3 p-3 border rounded-xl bg-white';
        row.innerHTML = `<input id="${id}" type="checkbox" class="mt-0.5 size-4"> <span>${txt}</span>`;
        box.appendChild(row);
      });
      $$('#checklistItems input').forEach(i=> i.addEventListener('change', saveState));
    }

    function exportJSON(){
      const stateRaw = localStorage.getItem(LS_KEY) || '{}';
      const blob = new Blob([stateRaw], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bb_guide_prefs.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          JSON.parse(e.target.result); // quick validation
          localStorage.setItem(LS_KEY, e.target.result);
          renderChecklist();
          renderPalette();
          loadState();
          toast('Imported settings');
        }catch(err){ alert('Invalid JSON'); }
      };
      reader.readAsText(file);
    }

    function resetAll(){
      if(!confirm('Reset all saved preferences?')) return;
      localStorage.removeItem(LS_KEY);
      renderChecklist();
      renderPalette();
      $('#ccColor').value = '';
      $('#ccUnderline').value = '';
      $('#ccSymbol').value = '';
      $('#toggleCompact').checked = false;
      $('#toggleAlt').checked = false;
      document.documentElement.classList.remove('text-[15px]');
      toast('Reset complete');
    }

    // Sampler logic
    function updateSample(){
      const text = $('#sampleText').value.trim();
      const color = $('#sampleColor').value;
      const u = $('#sampleUnderline').value;
      const box = $('#sampleBox').checked;
      const out = $('#sampleOut');
      if(!text){ out.innerHTML = '<span class="text-slate-500">Your formatted text will preview here…</span>'; return; }
      const span = document.createElement('span');
      span.textContent = text;
      span.style.background = color || 'transparent';
      span.className = (u ? (u + ' ') : '') + (box ? 'px-1 rounded border' : '');
      span.style.boxDecorationBreak = 'clone';
      out.innerHTML = '';
      out.appendChild(span);

      // Record underline usage when text exists
      try {
        const key = u || 'none';
        const usage = JSON.parse(localStorage.getItem(LS_UNDER_USAGE) || '{}');
        usage[key] = (usage[key] || 0) + 1;
        localStorage.setItem(LS_UNDER_USAGE, JSON.stringify(usage));
      } catch(e){}
    }

    // ===== Init =====
    renderPalette();
    renderChecklist();
    loadState();

    // ===== Events =====
    $('#btnPrint').addEventListener('click', ()=> window.print());
    $('#btnExport').addEventListener('click', exportJSON);
    $('#fileImport').addEventListener('change', (e)=>{ if(e.target.files[0]) importJSON(e.target.files[0]); e.target.value=''; });
    $('#btnReset').addEventListener('click', resetAll);

    $('#toggleCompact').addEventListener('change', (e)=>{
      document.documentElement.classList.toggle('text-[15px]', e.target.checked);
      saveState();
    });
    $('#toggleAlt').addEventListener('change', ()=>{ renderPalette(); saveState(); updateSample(); });

    $('#copyAllHex').addEventListener('click', ()=>{
      const list = currentPalette().map(p=> p.hex).join(', ');
      copy(list);
    });

    // Custom code fields save
    ['#ccColor','#ccUnderline','#ccSymbol'].forEach(sel=>{
      $(sel).addEventListener('input', saveState);
    });

    // Sampler
    ['#sampleText','#sampleColor','#sampleUnderline','#sampleBox'].forEach(sel=>{
      $(sel).addEventListener('input', updateSample);
      $(sel).addEventListener('change', updateSample);
    });
    $('#btnClearSample').addEventListener('click', ()=>{ $('#sampleText').value=''; updateSample(); });

    // Quick insert buttons
    $$('#sampler .chip').forEach(btn=>{
      btn.classList.add('px-2','py-1.5','rounded-xl','border','bg-white','hover:bg-slate-50');
      btn.addEventListener('click', ()=>{
        const t = $('#sampleText');
        t.value = (t.value? t.value + ' ' : '') + btn.dataset.insert;
        t.focus(); updateSample();
      });
    });

    // =====================
    // Step 4 worksheet logic
    const LS_STEP4 = 'bb_step4_v1';
    const LS_AMENDS = 'bb_amends_v1';

    function loadStep4(){
      try{
        const raw = localStorage.getItem(LS_STEP4);
        return raw ? JSON.parse(raw) : { resent:[], fears:[], sex:[] };
      }catch(e){ return { resent:[], fears:[], sex:[] }; }
    }

    function saveStep4(data){
      localStorage.setItem(LS_STEP4, JSON.stringify(data));
    }

    function renderStep4(){
      const data = loadStep4();
      renderRows(data.resent, 'resentRows');
      renderRows(data.fears, 'fearRows');
      renderRows(data.sex, 'sexRows');
    }

    function renderRows(list, containerId){
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      list.forEach((item, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex flex-wrap gap-2 items-start p-2 rounded-lg border bg-white/90';
        // brand theme: soft indigo border accent for tables
        row.style.borderColor = '#c7d2fe'; // indigo-200
        row.style.backgroundColor = '#eef2ff'; // indigo-50
        row.innerHTML = `
          <div class="flex-1 text-xs md:text-sm"><b>${escapeHTML(item.who)}</b></div>
          <div class="flex-1 text-xs md:text-sm">${escapeHTML(item.cause)}</div>
          <div class="flex-1 text-xs md:text-sm">${escapeHTML(item.affects)}</div>
          <div class="flex-1 text-xs md:text-sm">${escapeHTML(item.my)}</div>
          <button class="ml-auto text-xs text-red-600 hover:underline" data-idx="${idx}">Delete</button>
        `;
        row.querySelector('button').addEventListener('click', ()=>{
          const data = loadStep4();
          if(containerId === 'resentRows') data.resent.splice(idx,1);
          if(containerId === 'fearRows') data.fears.splice(idx,1);
          if(containerId === 'sexRows') data.sex.splice(idx,1);
          saveStep4(data);
          renderStep4();
        });
        container.appendChild(row);
      });
    }

    function addStep4Item(type){
      const data = loadStep4();
      const prefix = type;
      const who = document.getElementById(prefix+'Who').value.trim();
      const cause = document.getElementById(prefix+'Cause').value.trim();
      const affects = document.getElementById(prefix+'Affects').value.trim();
      const my = document.getElementById(prefix+'MyPart').value.trim();
      if(!who && !cause && !affects && !my) return;
      const entry = { who, cause, affects, my };
      if(type === 'resent') data.resent.push(entry);
      if(type === 'fear') data.fears.push(entry);
      if(type === 'sex') data.sex.push(entry);
      saveStep4(data);
      renderStep4();
      // clear inputs
      document.getElementById(prefix+'Who').value = '';
      document.getElementById(prefix+'Cause').value = '';
      document.getElementById(prefix+'Affects').value = '';
      document.getElementById(prefix+'MyPart').value = '';
    }

    // Export CSV for each category
    function exportCSV(list, filename){
      const header = ['Who/What','Cause','Affects','My part'];
      let csv = header.join(',') + '\n';
      list.forEach(item=>{
        const row = [item.who, item.cause, item.affects, item.my].map(v=> `"${(v||'').replace(/"/g,'\"')}"`).join(',');
        csv += row + '\n';
      });
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function exportStep4Markdown(){
      const data = loadStep4();
      let md = '# Step 4 Worksheet\n\n';
      function makeTable(title, list){
        let m = `## ${title}\n\n`;
        m += '| Who/What | Cause | Affects | My part |\n';
        m += '|---|---|---|---|\n';
        list.forEach(item=>{
          m += `| ${escapePipe(item.who)} | ${escapePipe(item.cause)} | ${escapePipe(item.affects)} | ${escapePipe(item.my)} |\n`;
        });
        m += '\n';
        return m;
      }
      md += makeTable('Resentments', data.resent);
      md += makeTable('Fears', data.fears);
      md += makeTable('Sex Conduct', data.sex);
      const blob = new Blob([md], {type: 'text/markdown'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'step4_worksheet.md'; a.click();
      URL.revokeObjectURL(url);
    }

    // Helpers to escape markdown/csv special chars
    function escapeHTML(str){ return String(str||'').replace(/[&<>"]/g, c=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' })[c]); }
    function escapePipe(str){ return String(str||'').replace(/\|/g, '\\|'); }

    // ================
    // Amends planner logic
    function loadAmends(){
      try{
        const raw = localStorage.getItem(LS_AMENDS);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveAmends(list){ localStorage.setItem(LS_AMENDS, JSON.stringify(list)); }
    function renderAmends(){
      const list = loadAmends();
      const container = document.getElementById('amendRows');
      container.innerHTML = '';
      list.forEach((item, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex flex-wrap gap-2 items-start p-2 rounded-lg border bg-white/90';
        // brand theming: blue border for amends
        row.style.borderColor = '#bae6fd'; // sky-200
        row.style.backgroundColor = '#e0f2fe'; // sky-50
        row.innerHTML = `
          <div class="flex-1 text-xs md:text-sm"><b>${escapeHTML(item.name)}</b> – ${escapeHTML(item.harm)}</div>
          <div class="text-xs md:text-sm px-1 py-0.5 rounded-full bg-slate-200">${escapeHTML(item.severity)}</div>
          <div class="text-xs md:text-sm px-1 py-0.5 rounded-full bg-slate-200">${escapeHTML(item.readiness)}</div>
          <div class="flex-1 text-xs md:text-sm">${escapeHTML(item.obstacles)}</div>
          <div class="flex-1 text-xs md:text-sm">${escapeHTML(item.next)}</div>
          <button class="ml-auto text-xs text-red-600 hover:underline" data-idx="${idx}">Delete</button>
        `;
        row.querySelector('button').addEventListener('click', ()=>{
          const list = loadAmends();
          list.splice(idx,1);
          saveAmends(list);
          renderAmends();
        });
        container.appendChild(row);
      });
    }
    function addAmend(){
      const name = $('#amendName').value.trim();
      const harm = $('#amendHarm').value.trim();
      const severity = $('#amendSeverity').value;
      const readiness = $('#amendReadiness').value;
      const obstacles = $('#amendObstacles').value.trim();
      const next = $('#amendNext').value.trim();
      if(!name && !harm) return;
      const list = loadAmends();
      list.push({ name, harm, severity, readiness, obstacles, next });
      saveAmends(list);
      renderAmends();
      // clear inputs
      $('#amendName').value=''; $('#amendHarm').value=''; $('#amendObstacles').value=''; $('#amendNext').value='';
      $('#amendSeverity').value='Low'; $('#amendReadiness').value='Not ready';
    }

    // ================
    // Encryption backup & restore
    async function deriveKey(pass, salt){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2', salt: salt, iterations:100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    }
    async function encryptData(data, pass){
      const enc = new TextEncoder();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(pass, salt);
      const encoded = enc.encode(data);
      const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv: iv}, key, encoded);
      const combined = new Uint8Array(salt.byteLength + iv.byteLength + cipher.byteLength);
      combined.set(salt, 0);
      combined.set(iv, salt.byteLength);
      combined.set(new Uint8Array(cipher), salt.byteLength + iv.byteLength);
      return btoa(String.fromCharCode(...combined));
    }
    async function decryptData(base64, pass){
      const bytes = Uint8Array.from(atob(base64), c=>c.charCodeAt(0));
      const salt = bytes.slice(0,16);
      const iv = bytes.slice(16,28);
      const data = bytes.slice(28);
      const key = await deriveKey(pass, salt);
      const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv: iv}, key, data);
      return new TextDecoder().decode(plain);
    }
    async function backupEncrypted(){
      const pass = prompt('Enter a passphrase for encryption:');
      if(!pass) return;
      const payload = {
        prefs: localStorage.getItem(LS_KEY) || null,
        step4: localStorage.getItem(LS_STEP4) || null,
        amends: localStorage.getItem(LS_AMENDS) || null
      };
      const json = JSON.stringify(payload);
      try{
        const encrypted = await encryptData(json, pass);
        const blob = new Blob([encrypted], {type:'application/octet-stream'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'bb_encrypted_backup.enc'; a.click();
        URL.revokeObjectURL(url);
        toast('Encrypted backup created');
      }catch(e){ alert('Encryption failed'); }
    }
    async function restoreEncrypted(){
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept='';
      inp.onchange = async (ev)=>{
        const file = ev.target.files[0];
        if(!file) return;
        const pass = prompt('Enter your passphrase to decrypt:');
        if(!pass) return;
        const reader = new FileReader();
        reader.onload = async (e)=>{
          try{
            const encryptedStr = e.target.result;
            const decrypted = await decryptData(encryptedStr, pass);
            const obj = JSON.parse(decrypted);
            if(obj.prefs) localStorage.setItem(LS_KEY, obj.prefs);
            if(obj.step4) localStorage.setItem(LS_STEP4, obj.step4);
            if(obj.amends) localStorage.setItem(LS_AMENDS, obj.amends);
            renderChecklist(); renderPalette(); loadState(); renderStep4(); renderAmends();
            toast('Encrypted backup restored');
          }catch(err){ alert('Failed to decrypt/restore'); console.error(err); }
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    // =====================
    // Auto-tag helper & Guided filters
    let sentenceSuggestions = [];
    let activeFilters = [];

    function parseSentences(text){
      // split on periods, exclamation, question marks or new lines
      return text.split(/(?<=[\.\!\?])\s+|\n+/).map(s=> s.trim()).filter(s=> s);
    }

    function suggestTagsForSentence(sentence){
      const tags = [];
      const s = sentence.toLowerCase();
      if(/\bwe (will|are|shall|can|must)\b/.test(s) || /\bwill know\b/.test(s)) tags.push('PRO');
      if(/\bif we\b/.test(s) && /\b(don't|do not|fail|refuse|neglect)\b/.test(s)) tags.push('WARN');
      if(/\bwe ask\b/.test(s) || /\bask him\b/.test(s) || /\bpray\b/.test(s)) tags.push('PRAY');
      if(/\b(list|inventory|confess|admit|decide|amends|make amends|inventory)\b/.test(s)) tags.push('ACT');
      if(/\bself\b|\bfear\b|\bangry\b|\bresentment\b|\bselfish\b|\bdishonest\b/.test(s)) tags.push('PR');
      if(/\bdefine\b|\bmeans\b|\bwhat (is|are)\b/.test(s)) tags.push('DEF');
      if(/\bquestion\b|\bwho\b|\bwhere\b|\bwhat\b/.test(s)) tags.push('Q');
      return Array.from(new Set(tags));
    }

    function renderTagHelper(){
      const text = $('#sampleText').value.trim();
      const tagHelper = document.getElementById('tagHelper');
      const tagList = document.getElementById('tagList');
      if(!text){ tagHelper.classList.add('hidden'); return; }
      const sentences = parseSentences(text);
      sentenceSuggestions = sentences.map(s => ({ text:s, tags: suggestTagsForSentence(s), selected: [] }));
      tagList.innerHTML = '';
      sentenceSuggestions.forEach((obj, idx)=>{
        const div = document.createElement('div');
        div.className = 'p-2 border rounded-lg bg-white flex flex-col gap-1';
        const sentDiv = document.createElement('div');
        sentDiv.textContent = obj.text;
        sentDiv.className = 'text-xs md:text-sm text-slate-700';
        div.appendChild(sentDiv);
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'flex flex-wrap gap-2 mt-1';
        if(obj.tags.length === 0){
          const note = document.createElement('span');
          note.textContent = 'No suggestion';
          note.className = 'text-xs italic text-slate-400';
          optionsDiv.appendChild(note);
        }else{
          obj.tags.forEach(tag=>{
            const id = `tag-${idx}-${tag}`;
            const label = document.createElement('label');
            label.className = 'flex items-center gap-1 text-xs';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.id = id;
            checkbox.addEventListener('change', (e)=>{
              if(e.target.checked) obj.selected.push(tag); else obj.selected = obj.selected.filter(t=> t!==tag);
            });
            label.appendChild(checkbox);
            const span = document.createElement('span');
            span.textContent = tag;
            span.className = 'px-1 py-0.5 rounded bg-slate-100 border text-[10px]';
            label.appendChild(span);
            optionsDiv.appendChild(label);
          });
        }
        div.appendChild(optionsDiv);
        tagList.appendChild(div);
      });
      tagHelper.classList.remove('hidden');
    }

    function applyTagSuggestions(){
      // Build formatted output with selected tags
      const out = document.getElementById('sampleOut');
      out.innerHTML = '';
      activeFilters = [];
      sentenceSuggestions.forEach((obj, idx)=>{
        const span = document.createElement('span');
        span.textContent = obj.text + (idx === sentenceSuggestions.length-1 ? '' : ' ');
        const tag = obj.selected[0];
        if(tag){
          // find palette color by code
          const pal = currentPalette();
          const item = pal.find(p=> p.code === tag);
          if(item){ span.style.background = item.hex; }
          span.dataset.cat = tag;
        }
        span.style.boxDecorationBreak = 'clone';
        out.appendChild(span);
      });
      createFilterButtons();
      applyFilters();
    }

    function createFilterButtons(){
      const container = document.getElementById('filterBtns');
      const fc = document.getElementById('filterControls');
      // Determine categories present
      const cats = Array.from(new Set(Array.from(document.getElementById('sampleOut').querySelectorAll('span[data-cat]')).map(sp=> sp.dataset.cat)));
      container.innerHTML = '';
      if(cats.length === 0){ fc.classList.add('hidden'); return; }
      cats.forEach(cat=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = cat;
        btn.className = 'px-2 py-1 rounded-lg text-xs border';
        btn.addEventListener('click', ()=>{
          // toggle filter
          if(activeFilters.includes(cat)) activeFilters = activeFilters.filter(c=> c!==cat);
          else activeFilters.push(cat);
          applyFilters();
          // update button style
          Array.from(container.children).forEach(b=>{
            const code = b.textContent;
            if(activeFilters.includes(code)){
              b.classList.add('bg-indigo-600','text-white'); b.classList.remove('bg-white');
            }else{
              b.classList.remove('bg-indigo-600','text-white'); b.classList.add('bg-white');
            }
          });
        });
        btn.classList.add('bg-white','hover:bg-slate-100');
        container.appendChild(btn);
      });
      fc.classList.remove('hidden');
    }

    function applyFilters(){
      const dim = document.getElementById('toggleDim').checked;
      const spans = document.getElementById('sampleOut').querySelectorAll('span');
      spans.forEach(sp=>{
        const cat = sp.dataset.cat;
        if(activeFilters.length === 0){
          // show all
          sp.classList.remove('dimmed');
          sp.style.display = '';
        }else{
          if(cat && activeFilters.includes(cat)){
            sp.classList.remove('dimmed');
            sp.style.display = '';
          }else{
            if(dim){
              sp.classList.add('dimmed');
              sp.style.display = '';
            }else{
              sp.style.display = 'none';
            }
          }
        }
      });
    }

    // Register event listeners for Step4 and Amends and backup
    document.getElementById('btnAddResent').addEventListener('click', ()=> addStep4Item('resent'));
    document.getElementById('btnAddFear').addEventListener('click', ()=> addStep4Item('fear'));
    document.getElementById('btnAddSex').addEventListener('click', ()=> addStep4Item('sex'));
    document.getElementById('btnCSVResent').addEventListener('click', ()=>{ const d=loadStep4(); exportCSV(d.resent,'resentments.csv'); });
    document.getElementById('btnCSVFear').addEventListener('click', ()=>{ const d=loadStep4(); exportCSV(d.fears,'fears.csv'); });
    document.getElementById('btnCSVSex').addEventListener('click', ()=>{ const d=loadStep4(); exportCSV(d.sex,'sex_conduct.csv'); });
    document.getElementById('btnExportStep4MD').addEventListener('click', exportStep4Markdown);
    document.getElementById('btnAddAmend').addEventListener('click', addAmend);
    document.getElementById('btnEncBackup').addEventListener('click', backupEncrypted);
    document.getElementById('btnEncRestore').addEventListener('click', restoreEncrypted);

    // Tag helper events
    document.getElementById('btnApplyTags').addEventListener('click', applyTagSuggestions);
    document.getElementById('toggleDim').addEventListener('change', applyFilters);

    // Monitor sample text for suggestions
    document.getElementById('sampleText').addEventListener('input', ()=>{ updateSample(); renderTagHelper(); });
    // Also update suggestions when palette changes
    document.getElementById('sampleColor').addEventListener('change', ()=>{ updateSample(); });

    // Initial load of Step4 and Amends
    renderStep4();
    renderAmends();

    // Service worker for offline caching
    if('serviceWorker' in navigator){
      try{
        const swCode = `self.addEventListener('install', event=>{event.waitUntil(caches.open('bb-cache').then(cache=>cache.add(self.registration.scope)).catch(()=>{}));});self.addEventListener('fetch', event=>{event.respondWith(caches.match(event.request).then(res=>res||fetch(event.request)));});`;
        const blob = new Blob([swCode], {type:'application/javascript'});
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(err=>{ console.warn('SW registration failed', err); });
      }catch(e){ console.warn('Service worker unavailable', e); }
    }

    // ===========================
    // Meeting Mode logic
    const DEFAULT_TOPICS = [
      'Acceptance', 'Gratitude', 'Service', 'Self‑will vs God’s will', 'Inventory',
      'Amends', 'Surrender', 'Fear', 'Faith', 'Honesty', 'Humility', 'Patience', 'Love and Tolerance'
    ];
    const DEFAULT_PRAYERS = [
      'God, grant me the serenity to accept the things I cannot change, courage to change the things I can, and wisdom to know the difference.',
      'I pray only for knowledge of His will for me and the power to carry that out.',
      'Relieve me of the bondage of self, that I may better do Thy will.',
      'Thy will, not mine, be done.',
      'Show me how to be of service to others today.'
    ];
    let selectedMeetingTime = 0;
    let timerInterval = null;

    function openMeetingModal() {
      // Populate random topic and prayer
      const topic = DEFAULT_TOPICS[Math.floor(Math.random() * DEFAULT_TOPICS.length)];
      const prayer = DEFAULT_PRAYERS[Math.floor(Math.random() * DEFAULT_PRAYERS.length)];
      $('#randomTopic').textContent = topic;
      $('#prayerText').textContent = prayer;
      // Reset selection
      selectedMeetingTime = 0;
      document.querySelectorAll('.timerBtn').forEach(btn => btn.classList.remove('ring', 'ring-offset-2', 'ring-indigo-500'));
      $('#meetingModal').classList.remove('hidden');
    }

    function beep() {
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 750;
        osc.connect(gain).connect(ctx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, 400);
      }catch(e){
        // fallback: no beep
      }
    }

    function startMeetingTimer() {
      if(!selectedMeetingTime) return;
      $('#meetingModal').classList.add('hidden');
      const end = Date.now() + selectedMeetingTime * 60 * 1000;
      beep();
      $('#timerOverlay').classList.remove('hidden');
      function update() {
        const diff = end - Date.now();
        if(diff <= 0) {
          clearInterval(timerInterval);
          $('#timerOverlay').textContent = '0:00';
          beep();
          setTimeout(()=> {
            $('#timerOverlay').classList.add('hidden');
          }, 1000);
          return;
        }
        const mins = Math.floor(diff/60000);
        const secs = Math.floor((diff%60000)/1000);
        $('#timerOverlay').textContent = mins + ':' + String(secs).padStart(2, '0');
      }
      update();
      timerInterval = setInterval(update, 1000);
    }

    // Event listeners for meeting mode
    document.getElementById('btnMeeting').addEventListener('click', openMeetingModal);
    document.getElementById('btnCloseMeeting').addEventListener('click', ()=> { $('#meetingModal').classList.add('hidden'); });
    document.querySelectorAll('.timerBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectedMeetingTime = parseInt(btn.getAttribute('data-time'), 10);
        document.querySelectorAll('.timerBtn').forEach(b=> b.classList.remove('ring', 'ring-offset-2', 'ring-indigo-500'));
        btn.classList.add('ring','ring-offset-2','ring-indigo-500');
      });
    });
    document.getElementById('btnStartTimer').addEventListener('click', startMeetingTimer);

    // Dismiss timer overlay on click
    document.getElementById('timerOverlay').addEventListener('click', ()=> {
      clearInterval(timerInterval);
      $('#timerOverlay').classList.add('hidden');
    });

    // ===========================
    // Flashcards logic
    let flashcards = [];
    let cardIndex = 0;
    let cardFlipped = false;

    function buildFlashcards() {
      flashcards = [];
      // From Step4 data: use 'my' as front, others as back
      const stepData = loadStep4();
      ['resent', 'fears', 'sex'].forEach(key=>{
        stepData[key].forEach(item=>{
          const front = (item.my || '').trim();
          if(front){
            const backParts = [];
            if(item.who) backParts.push('Who: '+item.who);
            if(item.cause) backParts.push('Cause: '+item.cause);
            if(item.affects) backParts.push('Affects: '+item.affects);
            const back = backParts.join(' | ');
            flashcards.push({ front: front, back: back || '(reflection)' });
          }
        });
      });
      // From definitions (palette)
      currentPalette().forEach(item=>{
        flashcards.push({ front: item.name, back: item.look });
      });
      cardIndex = 0;
      cardFlipped = false;
    }

    function renderFlashcard() {
      const area = document.getElementById('flashcardArea');
      const prevBtn = document.getElementById('btnPrevCard');
      const nextBtn = document.getElementById('btnNextCard');
      const flipBtn = document.getElementById('btnFlipCard');
      if(flashcards.length === 0) {
        area.innerHTML = '<span class="text-slate-500">No flashcards available</span>';
        prevBtn.disabled = true; nextBtn.disabled = true; flipBtn.disabled = true;
        return;
      }
      prevBtn.disabled = false; nextBtn.disabled = false; flipBtn.disabled = false;
      const card = flashcards[cardIndex];
      area.textContent = cardFlipped ? card.back : card.front;
    }

    function exportCardsCSV() {
      if(flashcards.length === 0) { toast('No flashcards to export'); return; }
      let csv = 'Front,Back\n';
      flashcards.forEach(c=>{
        const f = String(c.front || '').replace(/"/g,'""');
        const b = String(c.back || '').replace(/"/g,'""');
        csv += `"${f}","${b}"\n`;
      });
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'flashcards.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // Flashcards events
    document.getElementById('btnPrevCard').addEventListener('click', ()=>{
      if(!flashcards.length) return;
      cardIndex = (cardIndex - 1 + flashcards.length) % flashcards.length;
      cardFlipped = false;
      renderFlashcard();
    });
    document.getElementById('btnNextCard').addEventListener('click', ()=>{
      if(!flashcards.length) return;
      cardIndex = (cardIndex + 1) % flashcards.length;
      cardFlipped = false;
      renderFlashcard();
    });
    document.getElementById('btnFlipCard').addEventListener('click', ()=>{
      cardFlipped = !cardFlipped;
      renderFlashcard();
    });
    document.getElementById('btnExportCards').addEventListener('click', exportCardsCSV);

    // Rebuild flashcards whenever Step4 data or palette changes
    const originalRenderStep4 = renderStep4;
    renderStep4 = function() {
      originalRenderStep4();
      buildFlashcards();
      renderFlashcard();
      renderStreakHeatmap();
      // Update analytics after Step4 changes
      if(typeof renderAnalytics === 'function') renderAnalytics();
    };
    // Build initially
    buildFlashcards();

    // ===========================
    // Streak heatmap logic
    const LS_STREAK = 'bb_step4_streaks_v1';
    function recordStreak() {
      const day = new Date();
      // Normalize to local date string
      const iso = day.toISOString().slice(0,10);
      let streaks = {};
      try { streaks = JSON.parse(localStorage.getItem(LS_STREAK) || '{}'); } catch(e) {}
      streaks[iso] = (streaks[iso] || 0) + 1;
      localStorage.setItem(LS_STREAK, JSON.stringify(streaks));
    }
    function renderStreakHeatmap() {
      const container = document.getElementById('streakGrid');
      if(!container) return;
      container.innerHTML = '';
      let streaks = {};
      try { streaks = JSON.parse(localStorage.getItem(LS_STREAK) || '{}'); } catch(e) {}
      const today = new Date();
      const cells = [];
      for(let i=55; i>=0; i--) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        const dateStr = d.toISOString().slice(0,10);
        const count = streaks[dateStr] || 0;
        cells.push({ date: dateStr, count });
      }
      const max = cells.reduce((m,c)=> Math.max(m, c.count), 0);
      cells.forEach(c=>{
        const div = document.createElement('div');
        div.title = `${c.date}: ${c.count}`;
        // compute intensity 0..1
        const intensity = max ? c.count / max : 0;
        // HSL for indigo palette: base 245°, 70% saturation, vary lightness from 95% to 45%
        const light = 95 - (intensity * 50);
        div.style.backgroundColor = intensity === 0 ? '#f5f3ff' : `hsl(245,70%,${light}%)`;
        div.style.width = '100%';
        div.style.paddingTop = '100%';
        div.classList.add('rounded-sm');
        container.appendChild(div);
      });
    }

    // Wrap addStep4Item to record streak
    const originalAddStep4Item = addStep4Item;
    addStep4Item = function(type) {
      originalAddStep4Item(type);
      recordStreak();
    };
    // Render streak on initial load
    renderStreakHeatmap();

    // ===========================
    // Command palette & hotkeys
    const COMMANDS = [];
    function buildCommands() {
      COMMANDS.length = 0;
      // Section navigation
      $$('nav a[href^="#"]').forEach(link=>{
        const hash = link.getAttribute('href');
        const text = link.textContent.trim();
        COMMANDS.push({
          label: `Go to ${text}`,
          action: ()=>{ location.hash = hash; }
        });
      });
      // Additional actions
      COMMANDS.push(
        { label:'Toggle compact mode', action: ()=>{ $('#toggleCompact').click(); } },
        { label:'Toggle alt palette', action: ()=>{ $('#toggleAlt').click(); } },
        { label:'Open meeting mode', action: openMeetingModal },
        { label:'Export JSON', action: exportJSON },
        { label:'Clear sampler', action: ()=>{ $('#btnClearSample').click(); } },
        { label:'Backup (Encrypted)', action: backupEncrypted },
        { label:'Restore (Encrypted)', action: restoreEncrypted }
      );
    }
    buildCommands();

    let cmdIndex = -1;
    function openCmdPalette() {
      buildCommands();
      const overlay = document.getElementById('commandPalette');
      const list = document.getElementById('cmdList');
      const input = document.getElementById('cmdInput');
      input.value = '';
      filterCommands('');
      overlay.classList.remove('hidden');
      setTimeout(()=> input.focus(), 50);
    }
    function closeCmdPalette() {
      document.getElementById('commandPalette').classList.add('hidden');
      cmdIndex = -1;
    }
    function filterCommands(query) {
      const list = document.getElementById('cmdList');
      list.innerHTML = '';
      const q = query.toLowerCase();
      const matches = COMMANDS.filter(c=> c.label.toLowerCase().includes(q));
      matches.forEach((cmd, idx)=>{
        const li = document.createElement('li');
        li.textContent = cmd.label;
        li.className = 'p-2 rounded hover:bg-slate-100 cursor-pointer text-sm';
        if(idx === cmdIndex) li.classList.add('bg-slate-200');
        li.addEventListener('click', ()=>{ cmd.action(); closeCmdPalette(); });
        list.appendChild(li);
      });
      if(cmdIndex >= matches.length) cmdIndex = matches.length - 1;
    }
    document.getElementById('cmdInput').addEventListener('input', (e)=>{
      cmdIndex = -1;
      filterCommands(e.target.value);
    });
    document.addEventListener('keydown', (e)=>{
      const overlay = document.getElementById('commandPalette');
      // Ctrl+K or Cmd+K opens command palette
      if((e.key === 'k' || e.key === 'K') && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        if(overlay.classList.contains('hidden')) openCmdPalette(); else closeCmdPalette();
        return;
      }
      if(!overlay.classList.contains('hidden')) {
        const listEl = document.getElementById('cmdList');
        const items = Array.from(listEl.children);
        if(e.key === 'ArrowDown') {
          e.preventDefault();
          cmdIndex = (cmdIndex + 1) % items.length;
          filterCommands(document.getElementById('cmdInput').value);
          return;
        }
        if(e.key === 'ArrowUp') {
          e.preventDefault();
          cmdIndex = (cmdIndex - 1 + items.length) % items.length;
          filterCommands(document.getElementById('cmdInput').value);
          return;
        }
        if(e.key === 'Enter') {
          e.preventDefault();
          const q = document.getElementById('cmdInput').value.toLowerCase();
          const matches = COMMANDS.filter(c=> c.label.toLowerCase().includes(q));
          if(matches[cmdIndex] && typeof matches[cmdIndex].action === 'function') {
            matches[cmdIndex].action();
            closeCmdPalette();
          }
          return;
        }
        if(e.key === 'Escape') {
          e.preventDefault();
          closeCmdPalette();
          return;
        }
      }
    });

    // Global hotkeys (only when not focusing inputs or overlays)
    document.addEventListener('keydown', (e)=>{
      // Ignore if command palette or meeting is open or user is typing in input/textarea/select
      const overlayOpen = !document.getElementById('commandPalette').classList.contains('hidden') || !document.getElementById('meetingModal').classList.contains('hidden');
      if(overlayOpen) return;
      const tag = e.target.tagName.toLowerCase();
      if(tag === 'input' || tag === 'textarea' || tag === 'select' || e.target.isContentEditable) return;
      // Category hotkeys 1-8
      if(e.key >= '1' && e.key <= '8'){
        const idx = parseInt(e.key, 10) - 1;
        const sel = document.getElementById('sampleColor');
        if(sel && sel.options.length > idx){
          sel.selectedIndex = idx;
          sel.dispatchEvent(new Event('change'));
          e.preventDefault();
        }
        return;
      }
      // Underline shortcuts
      if(e.key.toLowerCase() === 'b'){ // toggle box
        const box = document.getElementById('sampleBox');
        if(box){ box.checked = !box.checked; box.dispatchEvent(new Event('change')); e.preventDefault(); }
      }
      if(e.key.toLowerCase() === 'u'){ // single underline
        const sel = document.getElementById('sampleUnderline');
        sel.value = 'u-single'; sel.dispatchEvent(new Event('change')); e.preventDefault();
      }
      if(e.key.toLowerCase() === 'd'){ // double underline
        const sel = document.getElementById('sampleUnderline');
        sel.value = 'u-double'; sel.dispatchEvent(new Event('change')); e.preventDefault();
      }
      if(e.key.toLowerCase() === 'w'){ // wavy underline
        const sel = document.getElementById('sampleUnderline');
        sel.value = 'u-wavy'; sel.dispatchEvent(new Event('change')); e.preventDefault();
      }
      if(e.key === '-'){
        const sel = document.getElementById('sampleUnderline');
        sel.value = 'u-dashed'; sel.dispatchEvent(new Event('change')); e.preventDefault();
      }
      if(e.key === '.'){
        const sel = document.getElementById('sampleUnderline');
        sel.value = 'u-dotted'; sel.dispatchEvent(new Event('change')); e.preventDefault();
      }
    });

    // =============================
    // Theme, Private mode, Share link & Export All
    function applyTheme(theme){
      const root = document.documentElement;
      if(theme === 'minimal'){
        root.style.setProperty('--bg-grad-from','0 0% 100%');
        root.style.setProperty('--bg-grad-to','0 0% 98%');
      }else if(theme === 'parchment'){
        root.style.setProperty('--bg-grad-from','42 100% 95%');
        root.style.setProperty('--bg-grad-to','42 100% 90%');
      }else{
        root.style.setProperty('--bg-grad-from','222 100% 98%');
        root.style.setProperty('--bg-grad-to','210 100% 96%');
      }
      localStorage.setItem(LS_THEME, theme);
    }
    function applyPrivateMode(on){
      ['step4','amends'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.classList.toggle('private-blur', !!on);
      });
      localStorage.setItem(LS_PRIVATE, on ? '1' : '0');
    }
    function copyShareLink(){
      const sanitize = document.getElementById('toggleSanitizeShare')?.checked || false;
      const obj = {
        alt: document.getElementById('toggleAlt')?.checked || false,
        ccColor: document.getElementById('ccColor')?.value || '',
        ccUnderline: document.getElementById('ccUnderline')?.value || '',
        ccSymbol: document.getElementById('ccSymbol')?.value || '',
        theme: localStorage.getItem(LS_THEME) || 'default',
        shift: localStorage.getItem(LS_PALETTE_SHIFT) || null
      };
      // Include sanitized Step4 and Amends for sponsor view if requested
      if(sanitize){
        obj.step4 = sanitizeStep4();
        obj.amends = sanitizeAmends();
      }
      try{
        const str = btoa(encodeURIComponent(JSON.stringify(obj)));
        const url = window.location.origin + window.location.pathname + '#share=' + str;
        navigator.clipboard.writeText(url).then(()=> toast('Share link copied')).catch(()=>{ prompt('Copy this link:', url); });
      }catch(e){ alert('Unable to generate link'); }
    }
    function applyShareFromHash(){
      const hash = window.location.hash;
      if(hash && hash.startsWith('#share=')){
        try{
          const data = JSON.parse(decodeURIComponent(atob(hash.slice(7))));
          if(data.alt !== undefined){ document.getElementById('toggleAlt').checked = !!data.alt; }
          if(data.ccColor){ document.getElementById('ccColor').value = data.ccColor; }
          if(data.ccUnderline){ document.getElementById('ccUnderline').value = data.ccUnderline; }
          if(data.ccSymbol){ document.getElementById('ccSymbol').value = data.ccSymbol; }
          if(data.theme){ applyTheme(data.theme); }
          if(data.shift){ localStorage.setItem(LS_PALETTE_SHIFT, data.shift); }
          // Apply sanitized Step4 and Amends if included
          if(data.step4){ localStorage.setItem(LS_STEP4, JSON.stringify(data.step4)); }
          if(data.amends){ localStorage.setItem(LS_AMENDS, JSON.stringify(data.amends)); }
          renderPalette();
          saveState();
          loadState();
          updateSample();
          // Render imported worksheets if present
          if(data.step4){ renderStep4(); }
          if(data.amends){ renderAmends(); }
          toast('Sponsor link applied');
        }catch(e){ console.warn('Failed to apply share link', e); }
      }
    }
    function exportAll(){
      const keys = [LS_KEY, LS_STEP4, LS_AMENDS, LS_STREAK, LS_CHECKINS, LS_PROMISES, LS_PRIVATE, LS_UNDER_USAGE, LS_PALETTE_SHIFT, LS_PALETTE_FILTER, LS_THEME];
      const data = {};
      keys.forEach(k=>{ data[k] = localStorage.getItem(k) || null; });
      const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'bb_full_backup.json'; a.click();
      URL.revokeObjectURL(url);
    }
    // Apply saved theme and private mode on load
    (function(){
      const th = localStorage.getItem(LS_THEME) || 'default';
      if(document.getElementById('themeSelect')) document.getElementById('themeSelect').value = th;
      applyTheme(th);
      const priv = localStorage.getItem(LS_PRIVATE) === '1';
      if(document.getElementById('togglePrivate')) document.getElementById('togglePrivate').checked = priv;
      applyPrivateMode(priv);
      applyShareFromHash();
    })();
    // Theme select change
    document.getElementById('themeSelect')?.addEventListener('change', e=>{ applyTheme(e.target.value); });
    // Private toggle change
    document.getElementById('togglePrivate')?.addEventListener('change', e=>{ applyPrivateMode(e.target.checked); });
    // Copy share link
    document.getElementById('btnCopyShare')?.addEventListener('click', copyShareLink);
    // Export all
    document.getElementById('btnExportAll')?.addEventListener('click', exportAll);
    // Settings modal logic
    document.getElementById('btnSettings')?.addEventListener('click', ()=>{
      const m = document.getElementById('settingsModal');
      if(m) m.classList.remove('hidden');
    });
    document.getElementById('settingsClose')?.addEventListener('click', ()=>{
      const m = document.getElementById('settingsModal');
      if(m) m.classList.add('hidden');
    });
    // Close settings modal when clicking outside the dialog content
    document.getElementById('settingsModal')?.addEventListener('click', (e)=>{
      if(e.target.id === 'settingsModal'){
        document.getElementById('settingsModal').classList.add('hidden');
      }
    });

    // =============================
    // Daily check-ins logic
    function loadCheckins(){
      try{ return JSON.parse(localStorage.getItem(LS_CHECKINS) || '{}'); }catch(e){ return {}; }
    }
    function saveCheckins(d){ localStorage.setItem(LS_CHECKINS, JSON.stringify(d)); }
    function renderCheckinHeatmap(data){
      const container = document.getElementById('checkinHeatmap');
      if(!container) return;
      container.innerHTML = '';
      const now = new Date();
      let max = 0;
      const cells = [];
      for(let i=27; i>=0; i--){
        const d = new Date();
        d.setDate(now.getDate() - i);
        const key = d.toISOString().slice(0,10);
        const entry = data[key];
        const count = (entry && entry.morning && entry.evening) ? 1 : 0;
        if(count>max) max = count;
        cells.push({date:key, count});
      }
      cells.forEach(c=>{
        const div = document.createElement('div');
        const intensity = max ? c.count / max : 0;
        const light = 95 - (intensity * 50);
        div.style.backgroundColor = intensity === 0 ? '#f0fdf4' : `hsl(128,60%,${light}%)`;
        div.style.width = '100%'; div.style.paddingTop = '100%'; div.classList.add('rounded-sm');
        div.title = `${c.date}: ${c.count ? 'Completed' : 'Missed'}`;
        container.appendChild(div);
      });
    }
    function renderCheckins(){
      const data = loadCheckins();
      const today = new Date().toISOString().slice(0,10);
      if(document.getElementById('morningInput')) document.getElementById('morningInput').value = (data[today]?.morning || '');
      if(document.getElementById('eveningInput')) document.getElementById('eveningInput').value = (data[today]?.evening || '');
      // compute streak
      let streak = 0;
      const now = new Date();
      for(let i=0;; i++){
        const d = new Date(); d.setDate(now.getDate() - i);
        const key = d.toISOString().slice(0,10);
        const entry = data[key];
        if(entry && entry.morning && entry.evening){ streak++; } else { break; }
      }
      const badge = document.getElementById('streakBadge');
      if(badge){
        if(streak > 0){ badge.textContent = `${streak} day${streak>1?'s':''} streak`; badge.classList.remove('hidden'); }
        else { badge.classList.add('hidden'); }
      }
      renderCheckinHeatmap(data);
    }
    document.getElementById('btnSaveCheckin')?.addEventListener('click', ()=>{
      const data = loadCheckins();
      const date = new Date().toISOString().slice(0,10);
      data[date] = { morning: document.getElementById('morningInput').value.trim(), evening: document.getElementById('eveningInput').value.trim() };
      saveCheckins(data);
      renderCheckins();
      renderAnalytics?.();
      toast('Saved check‑in');
    });
    renderCheckins();

    // =============================
    // Promise tracker logic
    function loadPromises(){ try{ return JSON.parse(localStorage.getItem(LS_PROMISES) || '[]'); }catch(e){ return []; } }
    function savePromises(list){ localStorage.setItem(LS_PROMISES, JSON.stringify(list)); }
    function updatePromiseProgress(){
      const list = loadPromises();
      const total = list.length;
      const done = list.filter(p=> p.done).length;
      if(document.getElementById('promiseTotal')) document.getElementById('promiseTotal').textContent = total;
      if(document.getElementById('promiseCount')) document.getElementById('promiseCount').textContent = done;
      const perc = total ? Math.round(done/total*100) : 0;
      if(document.getElementById('promiseProgress')) document.getElementById('promiseProgress').style.width = perc + '%';
    }
    function renderPromises(){
      const container = document.getElementById('promiseList');
      if(!container) return;
      container.innerHTML = '';
      const list = loadPromises();
      list.forEach((p,i)=>{
        const row = document.createElement('div');
        row.className = 'p-2 border rounded-lg bg-white flex flex-col';
        row.innerHTML = `
          <div class="flex items-center gap-2">
            <input type="checkbox" id="promiseChk${i}" ${p.done?'checked':''} class="size-4">
            <span class="flex-1 text-sm">${escapeHTML(p.text)}</span>
            <input type="date" id="promiseDate${i}" value="${p.date||''}" class="text-xs border rounded p-1">
            <button id="promiseDel${i}" class="text-xs text-red-500 ml-2">×</button>
          </div>
          <textarea id="promiseNote${i}" class="mt-1 w-full p-2 rounded border text-xs" rows="2" placeholder="Reflection…">${p.note||''}</textarea>
        `;
        container.appendChild(row);
        row.querySelector(`#promiseChk${i}`).addEventListener('change', (e)=>{
          const arr = loadPromises(); arr[i].done = e.target.checked; savePromises(arr); updatePromiseProgress(); renderAnalytics?.(); });
        row.querySelector(`#promiseDate${i}`).addEventListener('change', (e)=>{
          const arr = loadPromises(); arr[i].date = e.target.value; savePromises(arr); });
        row.querySelector(`#promiseNote${i}`).addEventListener('input', (e)=>{
          const arr = loadPromises(); arr[i].note = e.target.value; savePromises(arr); });
        row.querySelector(`#promiseDel${i}`).addEventListener('click', ()=>{
          const arr = loadPromises(); arr.splice(i,1); savePromises(arr); renderPromises(); renderAnalytics?.(); });
      });
      updatePromiseProgress();
    }
    document.getElementById('btnAddPromise')?.addEventListener('click', ()=>{
      const input = document.getElementById('newPromise');
      if(!input) return;
      const text = input.value.trim();
      if(!text) return;
      const arr = loadPromises(); arr.push({ text: text, done: false, date:'', note:'' }); savePromises(arr);
      input.value = '';
      renderPromises();
      renderAnalytics?.();
    });
    renderPromises();

    // =============================
    // Analytics panel logic
    function renderAnalytics(){
      const container = document.getElementById('analyticsContent');
      if(!container) return;
      container.innerHTML = '';
      // Step 4 counts
      const d = loadStep4();
      const counts = { 'Resentments': d.resent.length, 'Fears': d.fears.length, 'Sex Conduct': d.sex.length };
      const totalRows = counts['Resentments'] + counts['Fears'] + counts['Sex Conduct'];
      const barWrap = document.createElement('div');
      barWrap.innerHTML = '<h4 class="font-semibold text-sm mb-1">Step 4 rows</h4>';
      const barContainer = document.createElement('div'); barContainer.className = 'space-y-1';
      Object.keys(counts).forEach(key=>{
        const perc = totalRows ? Math.round(counts[key] / totalRows * 100) : 0;
        const row = document.createElement('div');
        row.className = 'text-xs flex items-center gap-2';
        row.innerHTML = `<span class="w-24">${key}</span><div class="flex-1 h-2 bg-slate-200 rounded"><div class="h-full bg-indigo-600 rounded" style="width:${perc}%"></div></div><span>${counts[key]}</span>`;
        barContainer.appendChild(row);
      });
      barWrap.appendChild(barContainer);
      container.appendChild(barWrap);
      // Step 4 entries last 7 days
      const streaks = JSON.parse(localStorage.getItem(LS_STREAK) || '{}');
      const now = new Date();
      let max = 0;
      const days = [];
      for(let i=6; i>=0; i--){
        const d2 = new Date(); d2.setDate(now.getDate() - i);
        const key = d2.toISOString().slice(0,10);
        const count = streaks[key] || 0;
        if(count > max) max = count;
        days.push({ date:key, count });
      }
      const chart = document.createElement('div');
      chart.innerHTML = '<h4 class="font-semibold text-sm mb-1">Step 4 entries (last 7 days)</h4>';
      const bars = document.createElement('div'); bars.className = 'flex items-end gap-1 h-20';
      days.forEach(d3=>{
        const bar = document.createElement('div');
        const h = max ? (d3.count / max * 100) : 0;
        bar.style.height = (h || 2) + '%';
        bar.className = 'flex-1 bg-indigo-400 rounded';
        bar.title = `${d3.date}: ${d3.count}`;
        bars.appendChild(bar);
      });
      chart.appendChild(bars);
      container.appendChild(chart);
      // Promise progress summary
      const plist = loadPromises();
      const doneP = plist.filter(p=> p.done).length;
      const totalP = plist.length;
      const ppWrap = document.createElement('div');
      ppWrap.innerHTML = '<h4 class="font-semibold text-sm mb-1">Promises progress</h4>';
      const barOuter = document.createElement('div'); barOuter.className = 'relative h-2 bg-slate-200 rounded-full overflow-hidden';
      const inner = document.createElement('div'); inner.className = 'absolute h-full bg-green-500 rounded-full';
      const percP = totalP ? Math.round(doneP / totalP * 100) : 0;
      inner.style.width = percP + '%';
      barOuter.appendChild(inner);
      ppWrap.appendChild(barOuter);
      ppWrap.innerHTML += `<p class="text-xs mt-1">${doneP}/${totalP} promises completed</p>`;
      container.appendChild(ppWrap);
      // Underline usage summary
      const usage = JSON.parse(localStorage.getItem(LS_UNDER_USAGE) || '{}');
      const uKeys = Object.keys(usage);
      if(uKeys.length){
        const uWrap = document.createElement('div');
        uWrap.innerHTML = '<h4 class="font-semibold text-sm mb-1">Underline usage</h4>';
        const totalU = uKeys.reduce((s,k)=> s + usage[k], 0);
        const list = document.createElement('div'); list.className = 'space-y-1';
        uKeys.forEach(k=>{
          const percU = totalU ? Math.round(usage[k] / totalU * 100) : 0;
          const row = document.createElement('div'); row.className = 'text-xs flex items-center gap-2';
          row.innerHTML = `<span class="w-24">${k}</span><div class="flex-1 h-2 bg-slate-200 rounded"><div class="h-full bg-amber-500 rounded" style="width:${percU}%"></div></div><span>${usage[k]}</span>`;
          list.appendChild(row);
        });
        uWrap.appendChild(list);
        container.appendChild(uWrap);
      }
    }
    // Render analytics on load
    renderAnalytics();

    // =============================
    // Compare excerpts logic
    function diffWords(a, b){
      const aa = a.trim().split(/\s+/);
      const bb = b.trim().split(/\s+/);
      const n = aa.length; const m = bb.length;
      // Compute LCS dynamic programming
      const dp = Array.from({length:n+1}, ()=> Array(m+1).fill(0));
      for(let i=1;i<=n;i++){
        for(let j=1;j<=m;j++){
          if(aa[i-1] === bb[j-1]) dp[i][j] = dp[i-1][j-1] + 1;
          else dp[i][j] = Math.max(dp[i-1][j], dp[i][j-1]);
        }
      }
      // Backtrack to mark matches
      let i=n, j=m;
      const matches = [];
      while(i>0 && j>0){
        if(aa[i-1] === bb[j-1]){
          matches.unshift({word: aa[i-1], type:'same'});
          i--; j--;
        }else if(dp[i-1][j] >= dp[i][j-1]){
          matches.unshift({word: aa[i-1], type:'del'});
          i--;
        }else{
          matches.unshift({word: bb[j-1], type:'add'});
          j--;
        }
      }
      while(i>0){ matches.unshift({word: aa[i-1], type:'del'}); i--; }
      while(j>0){ matches.unshift({word: bb[j-1], type:'add'}); j--; }
      // Build HTML
      const out = [];
      matches.forEach(item=>{
        if(item.type === 'same') out.push(escapeHTML(item.word));
        else if(item.type === 'add') out.push(`<span class="bg-green-200">${escapeHTML(item.word)}</span>`);
        else if(item.type === 'del') out.push(`<span class="bg-red-200 line-through">${escapeHTML(item.word)}</span>`);
      });
      return out.join(' ');
    }
    function doCompare(){
      const a = document.getElementById('compareA').value;
      const b = document.getElementById('compareB').value;
      const res = diffWords(a,b);
      const container = document.getElementById('compareResult');
      container.innerHTML = res;
    }
    document.getElementById('btnCompare')?.addEventListener('click', doCompare);

    // =============================
    // Palette tuner logic
    // Convert hex to HSL and back
    function hexToHsl(hex){
      hex = hex.replace('#','');
      const r = parseInt(hex.substring(0,2),16) / 255;
      const g = parseInt(hex.substring(2,4),16) / 255;
      const b = parseInt(hex.substring(4,6),16) / 255;
      const max = Math.max(r,g,b); const min = Math.min(r,g,b);
      let h,s,l; l = (max+min)/2;
      if(max === min){ h=s=0; }
      else{
        const d = max-min;
        s = l > 0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h = ((g-b)/d + (g<b?6:0)); break;
          case g: h = ((b-r)/d + 2); break;
          default: h = ((r-g)/d + 4); break;
        }
        h = h/6;
      }
      return {h: h*360, s: s*100, l: l*100};
    }
    function hslToHex(h,s,l){
      h/=360; s/=100; l/=100;
      let r,g,b;
      if(s===0){ r=g=b=l; }
      else{
        const hue2rgb = (p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p + (q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p + (q-p)*(2/3 - t)*6; return p; };
        const q = l < 0.5 ? l * (1 + s) : l + s - l*s;
        const p = 2 * l - q;
        r = hue2rgb(p,q,h + 1/3);
        g = hue2rgb(p,q,h);
        b = hue2rgb(p,q,h - 1/3);
      }
      const toHex = x=> ('0' + Math.round(x*255).toString(16)).slice(-2);
      return '#' + toHex(r) + toHex(g) + toHex(b);
    }
    function shiftHue(hex, deg){
      const hsl = hexToHsl(hex);
      hsl.h = (hsl.h + deg + 360) % 360;
      return hslToHex(hsl.h, hsl.s, hsl.l);
    }
    function applyHueShift(delta){
      // Save shift
      let shift = parseInt(localStorage.getItem(LS_PALETTE_SHIFT) || '0', 10);
      shift = shift + delta;
      localStorage.setItem(LS_PALETTE_SHIFT, shift);
      // Apply shift to palettes
      [PALETTE_BASE, PALETTE_ALT].forEach((pal, idx)=>{
        const orig = idx === 0 ? ORIG_PALETTE_BASE : ORIG_PALETTE_ALT;
        pal.forEach((item,i)=>{
          pal[i].hex = shiftHue(orig[i].hex, shift);
        });
      });
      renderPalette();
      buildFlashcards();
      renderFlashcard();
      renderPalettePreview();
    }
    // Color vision deficiency matrices
    const CVD_MATRICES = {
      none: null,
      protan: [
        [0.56667,0.43333,0],
        [0.55833,0.44167,0],
        [0,0.24167,0.75833]
      ],
      deutan: [
        [0.625,0.375,0],
        [0.7,0.3,0],
        [0,0.3,0.7]
      ],
      tritan: [
        [0.95,0.05,0],
        [0,0.43333,0.56667],
        [0,0.475,0.525]
      ]
    };
    function simulateCVD(hex, type){
      if(!CVD_MATRICES[type]) return hex;
      hex = hex.replace('#','');
      let r = parseInt(hex.substring(0,2),16);
      let g = parseInt(hex.substring(2,4),16);
      let b = parseInt(hex.substring(4,6),16);
      const m = CVD_MATRICES[type];
      const nr = m[0][0]*r + m[0][1]*g + m[0][2]*b;
      const ng = m[1][0]*r + m[1][1]*g + m[1][2]*b;
      const nb = m[2][0]*r + m[2][1]*g + m[2][2]*b;
      const toHex = x=> ('0' + Math.min(255, Math.max(0, Math.round(x))).toString(16)).slice(-2);
      return '#' + toHex(nr) + toHex(ng) + toHex(nb);
    }
    function renderPalettePreview(){
      const container = document.getElementById('palettePreview');
      if(!container) return;
      container.innerHTML = '';
      const pal = currentPalette();
      const filter = localStorage.getItem(LS_PALETTE_FILTER) || 'none';
      pal.forEach((item,i)=>{
        const hex = (localStorage.getItem(LS_PALETTE_SHIFT)? shiftHue(ORIG_PALETTE_BASE[i]?.hex || item.hex, parseInt(localStorage.getItem(LS_PALETTE_SHIFT))) : item.hex);
        const display = simulateCVD(hex, filter);
        const div = document.createElement('div');
        div.className = 'flex flex-col items-center text-xs';
        div.innerHTML = `<div class="w-8 h-8 rounded border" style="background:${display}"></div><span class="mt-1">${item.code}</span>`;
        container.appendChild(div);
      });
    }
    // Filter buttons
    document.getElementById('btnFilterNone')?.addEventListener('click', ()=>{ localStorage.setItem(LS_PALETTE_FILTER,'none'); renderPalettePreview(); });
    document.getElementById('btnFilterProtan')?.addEventListener('click', ()=>{ localStorage.setItem(LS_PALETTE_FILTER,'protan'); renderPalettePreview(); });
    document.getElementById('btnFilterDeutan')?.addEventListener('click', ()=>{ localStorage.setItem(LS_PALETTE_FILTER,'deutan'); renderPalettePreview(); });
    document.getElementById('btnFilterTritan')?.addEventListener('click', ()=>{ localStorage.setItem(LS_PALETTE_FILTER,'tritan'); renderPalettePreview(); });
    // Hue shift buttons
    document.getElementById('btnHueUp')?.addEventListener('click', ()=>{ applyHueShift(10); });
    document.getElementById('btnHueDown')?.addEventListener('click', ()=>{ applyHueShift(-10); });
    document.getElementById('btnResetPalette')?.addEventListener('click', ()=>{
      localStorage.removeItem(LS_PALETTE_SHIFT);
      // restore originals
      [PALETTE_BASE, PALETTE_ALT].forEach((pal, idx)=>{
        const orig = idx === 0 ? ORIG_PALETTE_BASE : ORIG_PALETTE_ALT;
        pal.forEach((item,i)=>{ pal[i].hex = orig[i].hex; });
      });
      renderPalette();
      buildFlashcards();
      renderFlashcard();
      renderPalettePreview();
    });
    renderPalettePreview();

    // =============================
    // Trash management
    const LS_TRASH = 'bb_trash';
    function loadTrash(){ try{ return JSON.parse(localStorage.getItem(LS_TRASH) || '[]'); }catch(e){ return []; } }
    function saveTrash(list){ localStorage.setItem(LS_TRASH, JSON.stringify(list)); }
    function addToTrash(obj){ const list = loadTrash(); list.push(obj); saveTrash(list); }
    function renderTrash(){
      const list = loadTrash();
      const container = document.getElementById('trashList');
      if(!container) return;
      container.innerHTML = '';
      if(list.length === 0){
        container.innerHTML = '<p class="text-sm text-slate-600">Trash is empty.</p>';
        return;
      }
      list.forEach((obj,i)=>{
        const row = document.createElement('div');
        row.className = 'p-2 border rounded flex items-start gap-2 bg-white';
        const label = obj.type === 'resent' || obj.type === 'fear' || obj.type === 'sex' ? 'Step 4' : (obj.type === 'amend' ? 'Amend' : '');
        row.innerHTML = `<div class="flex-1 text-xs md:text-sm"><b>${escapeHTML(obj.item.name || obj.item.who || '')}</b> <span class="text-slate-500">(${label})</span></div>
          <button id="restore${i}" class="text-xs px-2 py-1 rounded bg-green-500 text-white">Restore</button>
          <button id="delete${i}" class="text-xs px-2 py-1 rounded bg-red-500 text-white">Delete</button>`;
        container.appendChild(row);
        document.getElementById('restore'+i).addEventListener('click', ()=>{
          const arr = loadTrash();
          const item = arr.splice(i,1)[0];
          saveTrash(arr);
          if(item.type === 'resent' || item.type === 'fear' || item.type === 'sex'){
            const data = loadStep4();
            if(item.type === 'resent') data.resent.push(item.item);
            if(item.type === 'fear') data.fears.push(item.item);
            if(item.type === 'sex') data.sex.push(item.item);
            saveStep4(data);
            renderStep4();
            recordStreak?.();
            renderAnalytics?.();
          } else if(item.type === 'amend'){
            const listA = loadAmends(); listA.push(item.item); saveAmends(listA); renderAmends();
          }
          renderTrash();
        });
        document.getElementById('delete'+i).addEventListener('click', ()=>{
          const arr = loadTrash(); arr.splice(i,1); saveTrash(arr); renderTrash(); });
      });
    }
    document.getElementById('btnStep4Trash')?.addEventListener('click', ()=>{
      renderTrash();
      document.getElementById('trashModal').classList.remove('hidden');
    });
    document.getElementById('btnCloseTrash')?.addEventListener('click', ()=>{
      document.getElementById('trashModal').classList.add('hidden');
    });
    document.getElementById('btnEmptyTrash')?.addEventListener('click', ()=>{
      saveTrash([]);
      renderTrash();
    });

    // =============================
    // QR code generation
    function generateShareLink(){
      const obj = {
        alt: document.getElementById('toggleAlt')?.checked || false,
        ccColor: document.getElementById('ccColor')?.value || '',
        ccUnderline: document.getElementById('ccUnderline')?.value || '',
        ccSymbol: document.getElementById('ccSymbol')?.value || '',
        theme: localStorage.getItem(LS_THEME) || 'default',
        shift: localStorage.getItem(LS_PALETTE_SHIFT) || null
      };
      try{
        const str = btoa(encodeURIComponent(JSON.stringify(obj)));
        return window.location.origin + window.location.pathname + '#share=' + str;
      }catch(e){ return window.location.href; }
    }
    document.getElementById('btnShowQR')?.addEventListener('click', ()=>{
      const url = generateShareLink();
      const img = document.getElementById('qrImage');
      img.src = 'https://quickchart.io/qr?size=200&text=' + encodeURIComponent(url);
      document.getElementById('qrModal').classList.remove('hidden');
    });
    document.getElementById('btnCloseQR')?.addEventListener('click', ()=>{
      document.getElementById('qrModal').classList.add('hidden');
    });

    // =============================
    // Offline status and install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('btnInstall');
      if(btn) btn.classList.remove('hidden');
    });
    document.getElementById('btnInstall')?.addEventListener('click', ()=>{
      if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(()=>{
          deferredPrompt = null;
          document.getElementById('btnInstall').classList.add('hidden');
        });
      }
    });
    function updateOfflineStatus(){
      const el = document.getElementById('offlineStatus');
      if(!el) return;
      if(navigator.onLine){
        el.textContent = 'Online';
        el.className = 'px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-700';
      } else {
        el.textContent = 'Offline';
        el.className = 'px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-700';
      }
      el.classList.remove('hidden');
    }
    window.addEventListener('online', updateOfflineStatus);
    window.addEventListener('offline', updateOfflineStatus);
    updateOfflineStatus();

    // =============================
    // Confetti celebration
    function celebrate(){
      const container = document.createElement('div');
      container.style.position = 'fixed';
      container.style.left = '0';
      container.style.top = '0';
      container.style.width = '100%';
      container.style.height = '100%';
      container.style.pointerEvents = 'none';
      container.style.overflow = 'hidden';
      container.style.zIndex = '9999';
      document.body.appendChild(container);
      const colors = ['#F97316','#7C3AED','#2563EB','#F59E0B','#D946EF','#14B8A6','#0EA5E9','#22C55E'];
      for(let i=0;i<100;i++){
        const conf = document.createElement('div');
        conf.style.position = 'absolute';
        conf.style.width = '6px';
        conf.style.height = '8px';
        conf.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
        conf.style.left = Math.random()*100 + '%';
        conf.style.top = '-10px';
        conf.style.opacity = '0.8';
        conf.style.transform = 'rotate(' + (Math.random()*360) + 'deg)';
        container.appendChild(conf);
        const duration = 2000 + Math.random()*1000;
        const delay = Math.random()*300;
        conf.animate([
          { transform: conf.style.transform, top: '-10px' },
          { transform: 'rotate(' + (Math.random()*360) + 'deg)', top: '110%', opacity: 0.1 }
        ], { duration: duration, delay: delay, easing: 'ease-out' });
      }
      setTimeout(()=>{ container.remove(); }, 4000);
    }
    // Fire confetti on step4 export or 7-day streak
    const oldExportAll = exportAll;
    exportAll = function(){
      oldExportAll();
      celebrate();
    };
    const LS_STREAK_CELEBRATED = 'bb_streak_celebrated';
    // Override renderCheckins to fire confetti when hitting 7-day streak
    const originalRenderCheckins = renderCheckins;
    renderCheckins = function(){
      originalRenderCheckins();
      const data = loadCheckins();
      // compute streak length
      let streak = 0;
      const now = new Date();
      for(let i=0;;i++){
        const d = new Date(); d.setDate(now.getDate()-i);
        const key = d.toISOString().slice(0,10);
        const entry = data[key];
        if(entry && entry.morning && entry.evening){ streak++; } else { break; }
      }
      const lastCelebrated = localStorage.getItem(LS_STREAK_CELEBRATED);
      const today = new Date().toISOString().slice(0,10);
      if(streak >= 7 && lastCelebrated !== today){
        celebrate();
        localStorage.setItem(LS_STREAK_CELEBRATED, today);
      }
    };

    // =============================
    // Voice tools (dictation & TTS)
    function startDictation(inputId){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){ alert('Speech recognition not supported in this browser.'); return; }
      const rec = new SpeechRecognition();
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.onresult = function(e){
        const transcript = Array.from(e.results).map(r=> r[0].transcript).join(' ');
        const el = document.getElementById(inputId);
        if(el) el.value = transcript;
      };
      rec.onerror = function(e){ console.warn('Speech error', e); };
      rec.start();
    }
    function speakText(text){
      if(!('speechSynthesis' in window)){ alert('Text-to-speech not supported in this browser.'); return; }
      const utter = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utter);
    }
    // Attach microphone buttons
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.mic-btn');
      if(btn){
        const target = btn.getAttribute('data-target');
        if(target) startDictation(target);
      }
    });
    // Speak sample button
    document.getElementById('btnSpeakSample')?.addEventListener('click', ()=>{
      const txt = document.getElementById('sampleText')?.value || '';
      if(txt) speakText(txt);
    });

    // =============================
    // Group session tools
    const LS_SPEAKERS = 'bb_speakers';
    function loadSpeakers(){ try{ return JSON.parse(localStorage.getItem(LS_SPEAKERS) || '[]'); }catch(e){ return []; } }
    function saveSpeakers(list){ localStorage.setItem(LS_SPEAKERS, JSON.stringify(list)); }
    function formatTime(sec){ const m = Math.floor(sec/60); const s = sec % 60; return `${m}:${String(s).padStart(2,'0')}`; }
    let speakerTimerInterval;
    function updateSpeakerTimers(){
      const list = loadSpeakers();
      let active = false;
      list.forEach((sp,i)=>{
        if(sp.running){
          active = true;
          const now = Date.now();
          const elapsed = sp.elapsed + Math.round((now - sp.startTime)/1000);
          const timerElem = document.getElementById('timer'+i);
          if(timerElem) timerElem.textContent = formatTime(elapsed);
          if(!sp.alerted && elapsed >= 120){
            sp.alerted = true;
            // beep
            try{
              const ctx = new (window.AudioContext || window.webkitAudioContext)();
              const osc = ctx.createOscillator();
              osc.type = 'sine'; osc.frequency.value = 660;
              osc.connect(ctx.destination);
              osc.start(); osc.stop(ctx.currentTime + 0.3);
            }catch(err){}
          }
        }
      });
      if(!active){
        clearInterval(speakerTimerInterval);
        speakerTimerInterval = null;
      }
    }
    function renderSpeakers(){
      const ul = document.getElementById('speakerList');
      if(!ul) return;
      const list = loadSpeakers();
      ul.innerHTML = '';
      list.forEach((sp,i)=>{
        const li = document.createElement('li');
        li.className = 'p-2 border rounded flex items-center gap-2 justify-between bg-white';
        li.innerHTML = `<span class="flex-1 truncate">${escapeHTML(sp.name)}</span>
          <span id="timer${i}" class="text-xs text-slate-600">${formatTime(sp.elapsed || 0)}</span>
          <button id="start${i}" class="text-xs px-2 py-1 rounded ${sp.running? 'bg-red-600':'bg-green-600'} text-white">${sp.running? 'Stop':'Start'}</button>
          <button id="del${i}" class="text-xs px-2 py-1 rounded bg-red-500 text-white">×</button>`;
        ul.appendChild(li);
      });
      list.forEach((sp,i)=>{
        const startBtn = document.getElementById('start'+i);
        const delBtn = document.getElementById('del'+i);
        startBtn.onclick = ()=>{ toggleSpeaker(i); };
        delBtn.onclick = ()=>{ removeSpeaker(i); };
      });
    }
    function toggleSpeaker(i){
      const list = loadSpeakers();
      const sp = list[i];
      if(!sp) return;
      if(sp.running){
        // stop
        sp.running = false;
        const now = Date.now();
        sp.elapsed += Math.round((now - sp.startTime)/1000);
        sp.startTime = null;
      } else {
        // start
        sp.running = true;
        sp.startTime = Date.now();
        sp.alerted = false;
      }
      saveSpeakers(list);
      renderSpeakers();
      if(sp.running && !speakerTimerInterval){
        speakerTimerInterval = setInterval(updateSpeakerTimers, 1000);
      }
    }
    function removeSpeaker(i){
      const list = loadSpeakers();
      list.splice(i,1);
      saveSpeakers(list);
      renderSpeakers();
    }
    document.getElementById('btnAddSpeaker')?.addEventListener('click', ()=>{
      const inp = document.getElementById('newSpeaker');
      if(!inp) return;
      const name = inp.value.trim();
      if(!name) return;
      const list = loadSpeakers(); list.push({ name: name, elapsed: 0, running: false, startTime: null, alerted: false });
      saveSpeakers(list);
      inp.value = '';
      renderSpeakers();
    });
    document.getElementById('btnExportSpeakers')?.addEventListener('click', ()=>{
      const list = loadSpeakers();
      let csv = 'Name,Seconds\n';
      list.forEach(sp=>{
        const total = sp.elapsed + (sp.running ? Math.round((Date.now() - sp.startTime)/1000) : 0);
        csv += `"${sp.name.replace(/"/g,'""')}",${total}\n`;
      });
      const blob = new Blob([csv], { type:'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'speakers.csv'; a.click();
      URL.revokeObjectURL(url);
    });
    // Initial render of speakers
    renderSpeakers();

    /* ======================================================
       Additional helper functions for advanced sponsor tools
       Step 10 Spot Inventory, Step 11 Planner, Fuzzy Search,
       Tagging Drill, Sanitization, and PDF generation.
    ====================================================== */
    // --- Sanitization helpers ---
    function sanitizeName(str){
      if(!str) return '';
      const parts = str.trim().split(/\s+/);
      return parts.map(p=> p ? p[0] : '').join('');
    }
    function sanitizeStep4(){
      const data = loadStep4();
      const sanitized = { resent:[], fears:[], sex:[] };
      ['resent','fears','sex'].forEach(cat=>{
        data[cat].forEach(item=>{
          sanitized[cat].push({
            who: sanitizeName(item.who),
            cause: item.cause,
            affects: item.affects,
            my: item.my
          });
        });
      });
      return sanitized;
    }
    function sanitizeAmends(){
      const list = loadAmends();
      return list.map(item=>({
        name: sanitizeName(item.name),
        harm: item.harm,
        severity: item.severity,
        readiness: item.readiness,
        obstacles: item.obstacles,
        next: item.next
      }));
    }
    // --- Step 10 Spot Inventory ---
    function loadStep10(){
      try{ return JSON.parse(localStorage.getItem(LS_STEP10) || '[]'); }catch(e){ return []; }
    }
    function saveStep10(list){ localStorage.setItem(LS_STEP10, JSON.stringify(list)); }
    function renderStep10(){
      const container = document.getElementById('spotList');
      if(!container) return;
      const list = loadStep10();
      container.innerHTML = '';
      const grouped = {};
      list.forEach(item=>{
        const dateKey = item.date ? item.date.slice(0,10) : '';
        if(!grouped[dateKey]) grouped[dateKey] = [];
        grouped[dateKey].push(item);
      });
      Object.keys(grouped).sort().reverse().forEach(date=>{
        const dayDiv = document.createElement('div');
        dayDiv.className = 'mb-4';
        const title = document.createElement('h4');
        title.className = 'font-bold text-sm mb-1';
        title.textContent = date;
        dayDiv.appendChild(title);
        grouped[date].forEach(entry=>{
          const eDiv = document.createElement('div');
          eDiv.className = 'p-2 mb-2 border rounded-lg bg-white/90 text-xs';
          eDiv.innerHTML = `
            <div><b>What:</b> ${escapeHTML(entry.what||'')}</div>
            <div><b>My part:</b> ${escapeHTML(entry.part||'')}</div>
            <div><b>Resentment?</b> ${escapeHTML(entry.resentment||'')}</div>
            <div><b>Next action:</b> ${escapeHTML(entry.action||'')}</div>
          `;
          dayDiv.appendChild(eDiv);
        });
        container.appendChild(dayDiv);
      });
    }
    function initStep10(){
      document.getElementById('btnAddSpot')?.addEventListener('click', ()=>{
        document.getElementById('spotForm')?.classList.toggle('hidden');
      });
      document.getElementById('btnCancelSpot')?.addEventListener('click', ()=>{
        document.getElementById('spotForm')?.classList.add('hidden');
      });
      document.getElementById('btnSaveSpot')?.addEventListener('click', ()=>{
        const what = document.getElementById('spotWhat').value.trim();
        const part = document.getElementById('spotPart').value.trim();
        const resentment = document.getElementById('spotResentment').value.trim();
        const action = document.getElementById('spotAction').value.trim();
        if(!what && !part && !resentment && !action) return;
        const list = loadStep10();
        list.push({ date: new Date().toISOString(), what, part, resentment, action });
        saveStep10(list);
        renderStep10();
        document.getElementById('spotWhat').value = '';
        document.getElementById('spotPart').value = '';
        document.getElementById('spotResentment').value = '';
        document.getElementById('spotAction').value = '';
        document.getElementById('spotForm')?.classList.add('hidden');
      });
      renderStep10();
    }
    // --- Step 11 Planner ---
    function loadStep11(){
      try{ return JSON.parse(localStorage.getItem(LS_STEP11) || '{}'); }catch(e){ return {}; }
    }
    function saveStep11(data){ localStorage.setItem(LS_STEP11, JSON.stringify(data)); }
    function renderStep11(){
      const data = loadStep11();
      const mList = document.getElementById('morningPractices');
      if(mList){
        mList.innerHTML = '';
        (data.morning || []).forEach((item, idx)=>{
          const li = document.createElement('li');
          li.textContent = item;
          li.className = 'flex items-center justify-between p-1 border rounded bg-white/90';
          li.addEventListener('click', ()=>{
            const d = loadStep11();
            d.morning.splice(idx,1);
            saveStep11(d);
            renderStep11();
          });
          mList.appendChild(li);
        });
      }
      const eList = document.getElementById('eveningPractices');
      if(eList){
        eList.innerHTML = '';
        (data.evening || []).forEach((item, idx)=>{
          const li = document.createElement('li');
          li.textContent = item;
          li.className = 'flex items-center justify-between p-1 border rounded bg-white/90';
          li.addEventListener('click', ()=>{
            const d = loadStep11();
            d.evening.splice(idx,1);
            saveStep11(d);
            renderStep11();
          });
          eList.appendChild(li);
        });
      }
      const iList = document.getElementById('insightList');
      if(iList){
        iList.innerHTML = '';
        (data.insights || []).forEach((item, idx)=>{
          const li = document.createElement('li');
          li.textContent = item;
          li.className = 'flex items-center justify-between p-1 border rounded bg-white/90';
          li.addEventListener('click', ()=>{
            const d = loadStep11();
            d.insights.splice(idx,1);
            saveStep11(d);
            renderStep11();
          });
          iList.appendChild(li);
        });
      }
      if(document.getElementById('morningTime') && data.times){ document.getElementById('morningTime').value = data.times.morning || ''; }
      if(document.getElementById('eveningTime') && data.times){ document.getElementById('eveningTime').value = data.times.evening || ''; }
    }
    function scheduleNotification(title, delay){
      try{ new Notification(title, { body: 'Time for your practice' }); }catch(e){}
    }
    function setStep11Reminders(){
      const data = loadStep11();
      const mTime = document.getElementById('morningTime')?.value || '';
      const eTime = document.getElementById('eveningTime')?.value || '';
      if(!data.times) data.times = {};
      data.times.morning = mTime;
      data.times.evening = eTime;
      saveStep11(data);
      if('Notification' in window){
        Notification.requestPermission().then(permission=>{
          if(permission === 'granted'){
            if(mTime) scheduleNotification('Morning practice', 0);
            if(eTime) scheduleNotification('Evening practice', 0);
          }
        });
      }
      toast('Reminders set');
    }
    function initStep11(){
      document.getElementById('btnAddMorning')?.addEventListener('click', ()=>{
        const val = document.getElementById('morningPracticeInput').value.trim();
        if(!val) return;
        const data = loadStep11();
        if(!data.morning) data.morning = [];
        data.morning.push(val);
        saveStep11(data);
        document.getElementById('morningPracticeInput').value = '';
        renderStep11();
      });
      document.getElementById('btnAddEvening')?.addEventListener('click', ()=>{
        const val = document.getElementById('eveningPracticeInput').value.trim();
        if(!val) return;
        const data = loadStep11();
        if(!data.evening) data.evening = [];
        data.evening.push(val);
        saveStep11(data);
        document.getElementById('eveningPracticeInput').value = '';
        renderStep11();
      });
      document.getElementById('btnAddInsight')?.addEventListener('click', ()=>{
        const val = document.getElementById('insightInput').value.trim();
        if(!val) return;
        const data = loadStep11();
        if(!data.insights) data.insights = [];
        data.insights.push(val);
        saveStep11(data);
        document.getElementById('insightInput').value = '';
        renderStep11();
      });
      document.getElementById('btnSetReminders')?.addEventListener('click', setStep11Reminders);
      renderStep11();
    }
    // --- Search across data ---
    let fuseIndex;
    function buildSearchIndex(){
      const items = [];
      const step4 = loadStep4();
      ['resent','fears','sex'].forEach(cat=>{
        step4[cat].forEach(item=>{
          const text = [item.who, item.cause, item.affects, item.my].filter(Boolean).join(' ');
          items.push({ section:'Step4', text: text, anchor:'#step4' });
        });
      });
      loadAmends().forEach(item=>{
        const text = [item.name, item.harm, item.obstacles, item.next].filter(Boolean).join(' ');
        items.push({ section:'Amends', text: text, anchor:'#amends' });
      });
      const checkins = loadCheckins();
      Object.keys(checkins).forEach(date=>{
        const c = checkins[date];
        const text = [c.morning, c.evening].filter(Boolean).join(' ');
        if(text) items.push({ section:'Check-in', text: date + ' ' + text, anchor:'#checkins' });
      });
      loadPromises().forEach(item=>{
        items.push({ section:'Promise', text: item.text || '', anchor:'#promises' });
      });
      fuseIndex = new Fuse(items, { keys:['text'], includeScore:true, threshold:0.4 });
    }
    function doSearch(query){
      if(!fuseIndex) return [];
      return fuseIndex.search(query).slice(0,20);
    }
    function initSearch(){
      buildSearchIndex();
      const input = document.getElementById('searchInput');
      const results = document.getElementById('searchResults');
      if(!input || !results) return;
      input.addEventListener('input', ()=>{
        const q = input.value.trim();
        if(!q){ results.innerHTML = ''; return; }
        const res = doSearch(q);
        results.innerHTML = '';
        res.forEach(r=>{
          const li = document.createElement('li');
          li.innerHTML = `<a href="${r.item.anchor}" class="text-indigo-600 underline">${escapeHTML(r.item.text.substring(0,120))}</a>`;
          results.appendChild(li);
        });
      });
    }
    // --- Tagging drill ---
    let drillSentences = [];
    let drillIndex = 0;
    let drillScore = 0;
    function showNextSentence(){
      const sentenceEl = document.getElementById('drillSentence');
      const selectEl = document.getElementById('drillSelect');
      const feedback = document.getElementById('drillFeedback');
      const scoreEl = document.getElementById('drillScore');
      if(!sentenceEl || !selectEl) return;
      feedback.textContent = '';
      if(drillIndex >= drillSentences.length){
        sentenceEl.textContent = 'Drill complete!';
        selectEl.classList.add('hidden');
        document.getElementById('btnSubmitDrill')?.classList.add('hidden');
        scoreEl.textContent = `Score: ${drillScore} / ${drillSentences.length}`;
        return;
      }
      sentenceEl.textContent = drillSentences[drillIndex];
      selectEl.classList.remove('hidden');
      document.getElementById('btnSubmitDrill')?.classList.remove('hidden');
      scoreEl.textContent = `Current: ${drillScore} / ${drillSentences.length}`;
    }
    function startDrill(){
      const text = document.getElementById('drillText')?.value || '';
      const paragraphs = text.split(/[\.\?\!]/).map(s=> s.trim()).filter(s=> s.length>0);
      if(paragraphs.length === 0) return;
      drillSentences = paragraphs;
      drillIndex = 0;
      drillScore = 0;
      document.getElementById('drillGame')?.classList.remove('hidden');
      showNextSentence();
    }
    function initDrill(){
      document.getElementById('btnStartDrill')?.addEventListener('click', ()=>{
        startDrill();
      });
      document.getElementById('btnSubmitDrill')?.addEventListener('click', ()=>{
        drillScore++;
        drillIndex++;
        showNextSentence();
      });
    }

    // --- Step 5 Session Helper ---
    const LS_STEP5 = 'bb_step5_v1';
    function loadStep5(){ try{ return JSON.parse(localStorage.getItem(LS_STEP5) || '[]'); }catch(e){ return []; } }
    function saveStep5(list){ localStorage.setItem(LS_STEP5, JSON.stringify(list)); }
    function renderStep5(){
      const log = document.getElementById('session5Log');
      if(!log) return;
      const list = loadStep5();
      log.innerHTML = '';
      list.forEach(item => {
        const li = document.createElement('li');
        const dt = new Date(item.ts);
        li.textContent = dt.toLocaleString() + ' — ' + item.note;
        log.appendChild(li);
      });
    }
    function startSession5(){
      const timerEl = document.getElementById('session5Timer');
      const controls = document.getElementById('session5Controls');
      if(!timerEl || !controls) return;
      timerEl.textContent = 'Session started';
      controls.classList.add('hidden');
      let elapsed = 0;
      const chimes = [5, 10, 15];
      const interval = setInterval(()=>{
        elapsed++;
        timerEl.textContent = `Elapsed: ${elapsed} min`;
        if(chimes.includes(elapsed)){
          navigator.vibrate?.([100]);
          toast(`Session: ${elapsed} minute mark`);
        }
        if(elapsed >= 15){
          clearInterval(interval);
          timerEl.textContent = 'Session complete';
          controls.classList.remove('hidden');
        }
      }, 60000);
    }
    function initStep5(){
      document.getElementById('btnStartSession5')?.addEventListener('click', startSession5);
      document.getElementById('btnSaveSession5')?.addEventListener('click', ()=>{
        const noteEl = document.getElementById('session5Reflection');
        if(!noteEl) return;
        const note = noteEl.value.trim();
        if(!note) return;
        const list = loadStep5();
        list.unshift({ ts: new Date().toISOString(), note });
        saveStep5(list);
        noteEl.value = '';
        document.getElementById('session5Controls').classList.add('hidden');
        renderStep5();
      });
      renderStep5();
    }

    // --- Defect → Principle Mapper ---
    const DEFECT_MAP = {
      'resentment': ['forgiveness','compassion'],
      'fear': ['faith','courage'],
      'dishonesty': ['honesty','integrity'],
      'self‑pity': ['gratitude','humility'],
      'selfishness': ['service','generosity'],
      'anger': ['patience','love'],
      'pride': ['humility','modesty'],
    };
    function initDefectMap(){
      const sel = document.getElementById('defectSelect');
      if(!sel) return;
      sel.innerHTML = '<option value="">Select a defect…</option>';
      Object.keys(DEFECT_MAP).forEach(key => {
        const o = document.createElement('option');
        o.value = key;
        o.textContent = key.charAt(0).toUpperCase() + key.slice(1);
        sel.appendChild(o);
      });
      sel.addEventListener('change', () => {
        const defect = sel.value;
        const principles = DEFECT_MAP[defect] || [];
        const output = document.getElementById('principleOutput');
        const prayer = document.getElementById('prayerOutput');
        if(!defect){
          output.textContent = '';
          prayer.textContent = '';
        } else {
          output.textContent = 'Principles: ' + principles.join(', ');
          prayer.textContent = 'Prayer: God, please remove my ' + defect + ' and replace it with ' + principles.join(' and ') + '. Amen.';
        }
      });
    }

    // --- Service Tracker ---
    const LS_SERVICE = 'bb_service_v1';
    function loadService(){ try{ return JSON.parse(localStorage.getItem(LS_SERVICE) || '[]'); }catch(e){ return []; } }
    function saveService(list){ localStorage.setItem(LS_SERVICE, JSON.stringify(list)); }
    function renderService(){
      const list = loadService();
      const totals = {};
      list.forEach(item => { totals[item.type] = (totals[item.type] || 0) + 1; });
      const totalDiv = document.getElementById('serviceTotals');
      if(totalDiv){ totalDiv.textContent = Object.keys(totals).length ? Object.keys(totals).map(k => k + ': ' + totals[k]).join(' | ') : 'No entries yet.'; }
      const ul = document.getElementById('serviceLog');
      if(ul){ ul.innerHTML = '';
        list.slice().reverse().forEach(item => {
          const li = document.createElement('li');
          const dt = new Date(item.date);
          li.textContent = dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString() + ' – ' + item.type + (item.notes ? ': ' + item.notes : '');
          ul.appendChild(li);
        });
      }
    }
    function initService(){
      document.querySelectorAll('.serviceBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const type = btn.getAttribute('data-type');
          let notes = '';
          try{ notes = prompt('Notes (optional)') || ''; }catch(e){ notes = ''; }
          const list = loadService();
          list.push({ date: new Date().toISOString(), type, notes });
          saveService(list);
          renderService();
        });
      });
      renderService();
    }

    // --- Reading Plan ---
    const LS_READING = 'bb_reading_v1';
    function loadReading(){ try{ return JSON.parse(localStorage.getItem(LS_READING) || '[]'); }catch(e){ return []; } }
    function saveReading(list){ localStorage.setItem(LS_READING, JSON.stringify(list)); }
    function renderReading(){
      const list = loadReading();
      const ul = document.getElementById('readingList');
      const progressBar = document.getElementById('readingProgress');
      const progressText = document.getElementById('readingProgressText');
      if(ul){ ul.innerHTML = '';
        list.forEach((item, idx) => {
          const li = document.createElement('li');
          li.className = 'flex items-center gap-2';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!item.done;
          cb.addEventListener('change', () => {
            const arr = loadReading();
            arr[idx].done = cb.checked;
            saveReading(arr);
            renderReading();
          });
          const span = document.createElement('span');
          span.textContent = item.title;
          li.appendChild(cb);
          li.appendChild(span);
          ul.appendChild(li);
        });
      }
      const doneCount = list.filter(i => i.done).length;
      const pct = list.length ? Math.round(doneCount / list.length * 100) : 0;
      if(progressBar) progressBar.style.width = pct + '%';
      if(progressText) progressText.textContent = `${doneCount} / ${list.length} complete (${pct}%)`;
    }
    function initReadingPlan(){
      document.getElementById('btnAddReading')?.addEventListener('click', () => {
        const input = document.getElementById('readingInput');
        const val = input.value.trim();
        if(!val) return;
        const list = loadReading();
        if(list.length >= 30){ toast('Plan limited to 30 items'); return; }
        list.push({ title: val, done: false });
        saveReading(list);
        input.value = '';
        renderReading();
      });
      document.getElementById('btnExportReadingIcs')?.addEventListener('click', () => {
        const list = loadReading();
        if(list.length === 0){ toast('Add items first'); return; }
        const now = new Date();
        const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//BigBookStudy//ReadingPlan//EN'];
        list.forEach((item, idx) => {
          const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() + idx);
          const dt = start.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
          lines.push('BEGIN:VEVENT');
          lines.push('UID:bbstudy-reading-' + idx + '@localhost');
          lines.push('DTSTAMP:' + dt);
          lines.push('DTSTART;VALUE=DATE:' + dt.slice(0,8));
          lines.push('SUMMARY:' + item.title);
          lines.push('DESCRIPTION:' + item.title);
          lines.push('END:VEVENT');
        });
        lines.push('END:VCALENDAR');
        const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'reading_plan.ics';
        a.click();
        URL.revokeObjectURL(url);
      });
      renderReading();
    }

    // --- Recall Quiz ---
    function buildQuizQuestions(){
      const data = loadStep4();
      const phrases = [];
      ['resent','fears','sex'].forEach(cat => {
        data[cat].forEach(item => { if(item.my) phrases.push(item.my); });
      });
      const qs = [];
      phrases.forEach(ph => {
        const words = ph.split(/\s+/);
        if(words.length < 3) return;
        const idx = Math.floor(Math.random() * words.length);
        const answer = words[idx];
        const blankWords = words.slice();
        blankWords[idx] = '____';
        qs.push({ question: blankWords.join(' '), answer });
      });
      return qs;
    }
    function renderQuiz(){
      const area = document.getElementById('quizArea');
      if(!area) return;
      area.innerHTML = '';
      const qs = buildQuizQuestions();
      qs.forEach(q => {
        const div = document.createElement('div');
        div.className = 'p-2 border rounded bg-white/90';
        const p = document.createElement('p');
        p.textContent = q.question;
        const inp = document.createElement('input');
        inp.type = 'text'; inp.className = 'mt-1 w-full p-1 border rounded text-sm';
        const feedback = document.createElement('div'); feedback.className = 'text-xs mt-1';
        inp.addEventListener('change', () => {
          if(inp.value.trim().toLowerCase() === q.answer.toLowerCase()){
            feedback.textContent = 'Correct!';
            feedback.classList.remove('text-red-600');
            feedback.classList.add('text-green-600');
          } else {
            feedback.textContent = 'Answer: ' + q.answer;
            feedback.classList.remove('text-green-600');
            feedback.classList.add('text-red-600');
          }
        });
        div.appendChild(p);
        div.appendChild(inp);
        div.appendChild(feedback);
        area.appendChild(div);
      });
    }
    function initQuiz(){
      document.getElementById('btnGenerateQuiz')?.addEventListener('click', renderQuiz);
      document.getElementById('btnExportQuizCSV')?.addEventListener('click', () => {
        const qs = buildQuizQuestions();
        if(qs.length === 0){ toast('No questions'); return; }
        const lines = ['question,answer'];
        qs.forEach(q => {
          const qEsc = q.question.replace(/"/g, '""');
          const aEsc = q.answer.replace(/"/g, '""');
          lines.push('"' + qEsc + '","' + aEsc + '"');
        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'quiz.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    }

    // --- Snapshots ---
    const LS_SNAPSHOTS = 'bb_snapshots_v1';
    function loadSnapshots(){ try{ return JSON.parse(localStorage.getItem(LS_SNAPSHOTS) || '[]'); }catch(e){ return []; } }
    function saveSnapshots(list){ localStorage.setItem(LS_SNAPSHOTS, JSON.stringify(list)); }
    function saveSnapshot(){
      const list = loadSnapshots();
      const snapshot = {
        timestamp: new Date().toISOString(),
        data: { step4: loadStep4(), amends: loadAmends(), checkins: loadCheckins(), promises: loadPromises(), step10: loadStep10(), step11: loadStep11(), reading: loadReading(), service: loadService() }
      };
      list.push(snapshot);
      saveSnapshots(list);
      renderSnapshots();
      toast('Snapshot saved');
    }
    function renderSnapshots(){
      const div = document.getElementById('snapshotList');
      if(!div) return;
      const list = loadSnapshots();
      div.innerHTML = '';
      list.forEach((snap, idx) => {
        const btn = document.createElement('button');
        btn.className = 'block w-full text-left px-2 py-1 rounded hover:bg-slate-100';
        const dt = new Date(snap.timestamp);
        btn.textContent = (idx + 1) + '. ' + dt.toLocaleString();
        btn.addEventListener('click', () => {
          if(btn.classList.contains('selected')){
            btn.classList.remove('selected');
          } else {
            const selected = div.querySelectorAll('.selected');
            if(selected.length >= 2){ selected[0].classList.remove('selected'); }
            btn.classList.add('selected');
          }
          const selected = div.querySelectorAll('.selected');
          if(selected.length === 2){
            const idxA = Array.prototype.indexOf.call(div.children, selected[0]);
            const idxB = Array.prototype.indexOf.call(div.children, selected[1]);
            const snapA = list[idxA];
            const snapB = list[idxB];
            showDiff(snapA.data, snapB.data);
          } else {
            document.getElementById('diffArea').textContent = '';
          }
        });
        div.appendChild(btn);
      });
    }
    function showDiff(a, b){
      const area = document.getElementById('diffArea');
      if(!area) return;
      const diffs = [];
      function compare(objA, objB, prefix){
        Object.keys(objA).forEach(k => {
          if(typeof objA[k] === 'object' && objA[k] !== null){ compare(objA[k], (objB || {})[k], prefix + k + '.'); }
          else if(JSON.stringify(objA[k]) !== JSON.stringify((objB || {})[k])){
            diffs.push(prefix + k);
          }
        });
      }
      compare(a, b, '');
      compare(b, a, '');
      area.textContent = diffs.length ? 'Differences: ' + diffs.join(', ') : 'No differences';
    }
    function initSnapshots(){
      document.getElementById('btnSaveSnapshot')?.addEventListener('click', saveSnapshot);
      renderSnapshots();
    }

    // --- CSV Import ---
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      const rows = lines.map(l => l.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(s => s.replace(/^\"|\"$/g, '').trim()));
      return rows;
    }
    function initCSVImport(){
      document.getElementById('btnImportCSV')?.addEventListener('click', () => {
        const fileInput = document.getElementById('fileImportCSV');
        if(!fileInput.files || fileInput.files.length === 0){ toast('Select a file'); return; }
        const file = fileInput.files[0];
        const target = document.getElementById('csvTarget').value;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const rows = parseCSV(ev.target.result);
          if(rows.length === 0){ toast('No data'); return; }
          if(target === 'amends'){
            const am = loadAmends();
            rows.forEach(r => { am.push({ name: r[0] || '', harm: r[1] || '', severity: r[2] || 'Medium', readiness: r[3] || 'Willing', obstacles: r[4] || '', next: r[5] || '' }); });
            saveAmends(am);
            renderAmends();
          } else {
            const s4 = loadStep4();
            rows.forEach(r => {
              const entry = { who: r[0] || '', cause: r[1] || '', affects: r[2] || '', my: r[3] || '' };
              if(target === 'resent') s4.resent.push(entry);
              if(target === 'fears') s4.fears.push(entry);
              if(target === 'sex') s4.sex.push(entry);
            });
            saveStep4(s4);
            renderStep4();
          }
          toast('Import complete');
        };
        reader.readAsText(file);
        fileInput.value = '';
      });
    }

    // --- Emergency Plan ---
    const LS_EMERGENCY = 'bb_emergency_v1';
    function loadEmergency(){ try{ return JSON.parse(localStorage.getItem(LS_EMERGENCY) || '{}'); }catch(e){ return {}; } }
    function saveEmergency(data){ localStorage.setItem(LS_EMERGENCY, JSON.stringify(data)); }
    function startEmergencyTimer(){
      const countdown = document.getElementById('emCountdown');
      if(!countdown) return;
      let seconds = 180;
      countdown.textContent = '3:00';
      navigator.vibrate?.([100]);
      const interval = setInterval(() => {
        seconds--;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        countdown.textContent = m + ':' + s.toString().padStart(2, '0');
        if(seconds <= 0){
          clearInterval(interval);
          countdown.textContent = 'Done';
          navigator.vibrate?.([200]);
        }
      }, 1000);
    }
    function initEmergency(){
      const data = loadEmergency();
      if(document.getElementById('emCallList')) document.getElementById('emCallList').value = data.calls || '';
      if(document.getElementById('emPrayer')) document.getElementById('emPrayer').value = data.prayer || '';
      if(document.getElementById('emAction1')) document.getElementById('emAction1').value = (data.actions || [])[0] || '';
      if(document.getElementById('emAction2')) document.getElementById('emAction2').value = (data.actions || [])[1] || '';
      if(document.getElementById('emAction3')) document.getElementById('emAction3').value = (data.actions || [])[2] || '';
      document.getElementById('btnStartEmergency')?.addEventListener('click', startEmergencyTimer);
      const saveAll = () => {
        saveEmergency({ calls: document.getElementById('emCallList').value.trim(), prayer: document.getElementById('emPrayer').value.trim(), actions: [document.getElementById('emAction1').value.trim(), document.getElementById('emAction2').value.trim(), document.getElementById('emAction3').value.trim()] });
      };
      ['emCallList','emPrayer','emAction1','emAction2','emAction3'].forEach(id => { document.getElementById(id)?.addEventListener('change', saveAll); });
    }

    // --- Accessibility Options ---
    function initAccessibility(){
      const slider = document.getElementById('fontSizeSlider');
      const valEl = document.getElementById('fontSizeValue');
      const hc = document.getElementById('toggleHighContrast');
      if(slider){
        slider.addEventListener('input', () => {
          const size = slider.value;
          document.documentElement.style.fontSize = size + 'px';
          if(valEl) valEl.textContent = size + 'px';
        });
      }
      if(hc){
        hc.addEventListener('change', () => {
          document.body.classList.toggle('high-contrast', hc.checked);
        });
      }
    }
    // --- Sponsor review packet ---
    function generateSponsorPacket(){
      try{
        const { jsPDF } = window.jspdf || {};
        if(!jsPDF){ alert('jsPDF library not loaded'); return; }
        const doc = new jsPDF();
        const now = new Date();
        doc.setFontSize(16);
        doc.text('Sponsor Review Packet', 10, 10);
        doc.setFontSize(10);
        doc.text('Generated: ' + now.toLocaleString(), 10, 16);
        let y = 24;
        const s4 = loadStep4();
        const renderTable = (title, list)=>{
          doc.setFontSize(12);
          doc.text(title, 10, y); y += 6;
          doc.setFontSize(8);
          list.forEach((it, idx)=>{
            const line = `${idx+1}. Who: ${it.who || ''} | Cause: ${it.cause || ''} | Affects: ${it.affects || ''} | My: ${it.my || ''}`;
            doc.text(line.substring(0, 100), 12, y);
            y += 5;
            if(y > 270){ doc.addPage(); y = 10; }
          });
        };
        renderTable('Step 4 - Resentments', s4.resent);
        renderTable('Step 4 - Fears', s4.fears);
        renderTable('Step 4 - Sex Conduct', s4.sex);
        const am = loadAmends();
        doc.setFontSize(12);
        doc.text('Amends Plan', 10, y); y += 6;
        doc.setFontSize(8);
        am.forEach((it, idx)=>{
          const line = `${idx+1}. ${it.name || ''} – ${it.harm || ''} (Severity: ${it.severity || ''}, Readiness: ${it.readiness || ''}) Obstacles: ${it.obstacles || ''} | Next: ${it.next || ''}`;
          doc.text(line.substring(0, 100), 12, y);
          y += 5;
          if(y > 270){ doc.addPage(); y = 10; }
        });
        const promises = loadPromises();
        const completed = promises.filter(p=> p.completed).length;
        doc.setFontSize(12);
        doc.text('Promise Progress', 10, y); y += 6;
        doc.setFontSize(8);
        doc.text(`Completed: ${completed} / ${promises.length}`, 12, y); y += 5;
        const checkins = loadCheckins();
        let streak = 0;
        {
          const nowDate = new Date();
          for(let i=0;; i++){
            const d = new Date(nowDate);
            d.setDate(nowDate.getDate() - i);
            const key = d.toISOString().slice(0,10);
            const entry = checkins[key];
            if(entry && entry.morning && entry.evening){ streak++; } else { break; }
          }
        }
        doc.text(`Daily check‑in streak: ${streak} day${streak>1?'s':''}`, 12, y); y += 6;
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Notes', 10, 10);
        doc.setFontSize(8);
        for(let i=0; i<25; i++){
          const lineY = 14 + i*7;
          doc.line(10, lineY, 200, lineY);
        }
        doc.save('SponsorReview.pdf');
      }catch(e){
        alert('Error generating PDF');
      }
    }
    // --- Initialize all new modules after DOM loads ---
    document.addEventListener('DOMContentLoaded', ()=>{
      // Set dynamic year in the footer
      const yrEl = document.getElementById('currentYear');
      if(yrEl) yrEl.textContent = new Date().getFullYear();

      document.getElementById('btnSponsorPacket')?.addEventListener('click', generateSponsorPacket);
      document.getElementById('btnSpotWidget')?.addEventListener('click', ()=>{
        const sec = document.getElementById('step10');
        if(sec) sec.scrollIntoView({ behavior:'smooth' });
        document.getElementById('spotForm')?.classList.remove('hidden');
      });
      initStep10();
      initStep11();
      initSearch();
      initDrill();
      // initialize new tools
      initStep5();
      initDefectMap();
      initService();
      initReadingPlan();
      initQuiz();
      initSnapshots();
      initCSVImport();
      initEmergency();
      initAccessibility();
    });

    // Hook Step4 deletion to trash
    const originalRenderRows = renderRows;
    renderRows = function(list, containerId){
      originalRenderRows(list, containerId);
      // after rendering, override delete buttons to push to trash
      const container = document.getElementById(containerId);
      container?.querySelectorAll('button[data-idx]')?.forEach(btn=>{
        const idx = parseInt(btn.getAttribute('data-idx'));
        btn.removeEventListener('click', btn._trashHandler);
        btn._trashHandler = function(){
          const data = loadStep4();
          let item;
          if(containerId === 'resentRows') item = data.resent[idx];
          if(containerId === 'fearRows') item = data.fears[idx];
          if(containerId === 'sexRows') item = data.sex[idx];
          // push to trash
          addToTrash({ type: containerId === 'resentRows' ? 'resent' : (containerId === 'fearRows' ? 'fear' : 'sex'), item: item });
          // delete
          if(containerId === 'resentRows') data.resent.splice(idx,1);
          if(containerId === 'fearRows') data.fears.splice(idx,1);
          if(containerId === 'sexRows') data.sex.splice(idx,1);
          saveStep4(data);
          renderStep4();
          recordStreak?.();
          renderAnalytics?.();
        };
        btn.addEventListener('click', btn._trashHandler);
      });
    };
    // Hook Amends deletion to trash
    const originalRenderAmends = renderAmends;
    renderAmends = function(){
      originalRenderAmends();
      const container = document.getElementById('amendRows');
      container?.querySelectorAll('button[data-idx]')?.forEach(btn=>{
        const idx = parseInt(btn.getAttribute('data-idx'));
        btn.removeEventListener('click', btn._trashHandler);
        btn._trashHandler = function(){
          const list = loadAmends();
          const item = list[idx];
          addToTrash({ type:'amend', item: item });
          list.splice(idx,1);
          saveAmends(list);
          renderAmends();
        };
        btn.addEventListener('click', btn._trashHandler);
      });
    };
  </script>
  <!-- Navigation script to toggle main content sections -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Identify all top-level content areas
      const mainSections = document.querySelectorAll('.main-content-section');
      // Attach click handlers to top-level navigation links
      document.querySelectorAll('.nav-main-link').forEach(link => {
        link.addEventListener('click', ev => {
          const targetHash = link.getAttribute('href');
          if (targetHash && targetHash.startsWith('#')) {
            ev.preventDefault();
            const targetId = targetHash.slice(1);
            // Show the target section and hide all others
            mainSections.forEach(sec => {
              if (sec.id === targetId) {
                sec.classList.remove('hidden');
              } else {
                sec.classList.add('hidden');
              }
            });
            // If switching away from Tools, collapse any open nested menus for clarity
            if (targetId !== 'tools') {
              document.querySelectorAll('aside details[open]').forEach(det => {
                det.removeAttribute('open');
              });
            }
          }
        });
      });
    });
  </script>
</body>
</html>
